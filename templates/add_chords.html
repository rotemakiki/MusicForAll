


<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×•×¡×¤×ª ××§×•×¨×“×™× ×œ×©×™×¨</title>
</head>
<body>
    <div class="main-container">
        <!-- Main Content Area -->
        <div class="main-content">
            <h1>ğŸµ ×”×•×¡×¤×ª ××§×•×¨×“×™× ×œ×©×™×¨</h1>

            <!-- Current Measure Builder -->
            <div class="measure-builder">
                <h3>ğŸ“¦ ×‘× ×™×™×ª ×ª×™×‘×” × ×•×›×—×™×ª</h3>

                <div class="measure-controls">
                    <div class="input-group">
                        <label>ğŸ”¢ ××¡×¤×¨ × ×§×™×©×•×ª ×‘×ª×™×‘×”:</label>
                        <input type="number" id="measure-beats" value="4" min="1" max="16">
                        <button class="btn small-btn" onclick="createNewMeasure()">×¦×•×¨ ×ª×™×‘×” ×—×“×©×”</button>
                    </div>
                </div>

                <!-- Current Measure Preview -->
                <div id="current-measure-container" class="measure-container">
                    <div class="measure-placeholder">
                        <p>ğŸ‘ˆ ×œ×—×¥ "×¦×•×¨ ×ª×™×‘×” ×—×“×©×”" ×›×“×™ ×œ×”×ª×—×™×œ</p>
                    </div>
                </div>

                <!-- Measure Action Buttons -->
                <div class="measure-actions">
                    <button class="btn" onclick="addMeasureToLine()" id="add-to-line-btn" disabled>
                        â¬…ï¸ ×”×•×¡×£ ×ª×™×‘×” ×œ×©×•×¨×”
                    </button>
                    <button class="btn secondary-btn" onclick="createNewLine()">
                        â¬‡ï¸ ×©×•×¨×” ×—×“×©×”
                    </button>
                </div>
            </div>

            <!-- Song Structure Display -->
            <div class="song-structure">
                <h3>ğŸ¼ ××‘× ×” ×”×©×™×¨</h3>
                <div id="song-lines"></div>

                <div class="finish-controls">
                    <button class="btn finish-btn" onclick="finishAndReturn()">
                        âœ… ×¡×™×™× ×•×”××©×š
                    </button>
                </div>
            </div>
        </div>

        <!-- Chord Selector Sidebar -->
        <div class="chord-sidebar">
            <h3>ğŸ¸ ×‘×—×¨ ××§×•×¨×“</h3>

            <!-- Root Note Selection -->
            <div class="section">
                <h4>×‘×—×¨ ×ª×• ×™×¡×•×“:</h4>
                <div id="root-letters" class="button-grid"></div>
            </div>

            <!-- Accidental Toggle -->
            <button id="toggle-accidental" class="accidental-btn">â™® ×œ×œ× ×¡×™××Ÿ</button>

            <!-- Chord Type Selection -->
            <div class="section">
                <h4>×‘×—×¨ ×¡×•×’ ××§×•×¨×“:</h4>
                <div id="chord-types" class="button-grid"></div>
            </div>

            <!-- Current Selection Display -->
            <div class="current-selection">
                <strong>××§×•×¨×“ × ×‘×—×¨:</strong>
                <div id="current-chord-display">â€”</div>
            </div>

            <!-- Add Chord Button -->
            <button class="btn add-chord-btn" onclick="addChordToCurrentMeasure()" disabled>
                â• ×”×•×¡×£ ××§×•×¨×“ ×œ×ª×™×‘×”
            </button>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="btn small-btn secondary-btn" onclick="clearCurrentMeasure()" id="clear-measure-btn" disabled>
                    ğŸ—‘ï¸ × ×§×” ×ª×™×‘×”
                </button>
            </div>
        </div>
    </div>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f7fa;
            direction: rtl;
            user-select: none;
        }

        .main-container {
            display: flex;
            min-height: 100vh;
            gap: 20px;
        }

        /* Chord Sidebar */
        .chord-sidebar {
            width: 280px;
            background: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .chord-sidebar h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .section {
            margin-bottom: 25px;
        }

        .section h4 {
            color: #555;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(45px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }

        .chord-btn {
            padding: 12px 8px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chord-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .chord-btn.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .accidental-btn {
            width: 100%;
            padding: 12px;
            border: 2px solid #6c757d;
            border-radius: 8px;
            background: #6c757d;
            color: white;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .accidental-btn:hover {
            background: #545b62;
            border-color: #545b62;
        }

        .current-selection {
            background: #f8f9ff;
            border: 2px solid #b4d7ff;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        #current-chord-display {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-top: 8px;
        }

        .add-chord-btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            max-width: calc(100vw - 320px);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .measure-builder {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .measure-builder h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .measure-controls {
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .input-group label {
            font-weight: 500;
            color: #555;
        }

        .input-group input {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            width: 80px;
        }

        .measure-container {
            border: 3px dashed #ccc;
            border-radius: 12px;
            min-height: 120px;
            margin-bottom: 20px;
            position: relative;
            background: #fafbfc;
        }

        .measure-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 120px;
            color: #999;
            font-style: italic;
        }

        .measure-preview {
            display: flex;
            align-items: stretch;
            height: 120px;
            padding: 15px;
            gap: 0;
            position: relative;
        }

        .chord-in-measure {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            position: relative;
            transition: all 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
            margin: 0 1px;
            min-width: 60px;
        }

        .chord-in-measure:hover {
            border-color: #ffd700;
            transform: translateY(-2px);
            z-index: 10;
        }

        .chord-in-measure.selected {
            border-color: #ff4757;
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.3);
        }

        .chord-name {
            font-size: 18px;
            line-height: 1;
        }

        .chord-beats {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .chord-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .chord-in-measure:hover .chord-remove {
            display: flex;
        }

        .resize-handle {
            width: 12px;
            cursor: ew-resize;
            background: linear-gradient(to bottom, #28a745, #1e7e34);
            border-radius: 6px;
            position: relative;
            transition: all 0.2s;
            margin: 10px 0;
            opacity: 0.7;
        }

        .resize-handle:hover {
            background: linear-gradient(to bottom, #ffd700, #ffc107);
            width: 16px;
            opacity: 1;
        }

        .resize-handle.dragging {
            background: linear-gradient(to bottom, #ff4757, #ff3838);
            width: 20px;
            opacity: 1;
        }

        .resize-handle::before {
            content: 'â‹®â‹®';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            line-height: 0.6;
        }

        .measure-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .song-structure {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .song-structure h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .song-line {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8faff;
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            flex-wrap: wrap;
            align-items: center;
            direction: ltr;
        }

        .measure-in-line {
            display: flex;
            border: 2px solid #007bff;
            border-radius: 8px;
            overflow: hidden;
            min-width: 120px;
            height: 60px;
        }

        .finish-controls {
            text-align: center;
            margin-top: 30px;
        }

        /* Button Styles */
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .small-btn {
            padding: 8px 15px;
            font-size: 13px;
        }

        .secondary-btn {
            background: #6c757d;
        }

        .secondary-btn:hover {
            background: #545b62;
        }

        .finish-btn {
            background: #28a745;
            padding: 15px 30px;
            font-size: 16px;
        }

        .finish-btn:hover {
            background: #218838;
        }

        /* Width input popup */
        .width-input-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #007bff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        .width-input-popup.show {
            display: block;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .popup-overlay.show {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .chord-sidebar {
                width: 100%;
                height: auto;
                position: static;
            }

            .main-content {
                max-width: 100%;
            }

            .button-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>

    <script>
        // Chord system configuration
        const rootLetters = ["A", "B", "C", "D", "E", "F", "G"];
        const accidentalOptions = ["", "#", "b"];
        const chordTypes = ["", "m", "7", "maj7", "dim", "sus4", "aug", "m7"];

        // State variables
        let accidentalIndex = 0;
        let selectedLetter = null;
        let selectedType = "";
        let currentMeasure = null;
        let songStructure = [[]]; // Array of lines, each line contains measures
        let selectedChordIndex = -1;

        // Drag and resize state
        let isDragging = false;
        let dragIndex = null;
        let startX = 0;
        let originalWidths = [];

        // Initialize the page
        function init() {
            renderRootButtons();
            renderTypeButtons();
            renderSongStructure();
            updateAccidentalButton();
        }

        // Get current accidental symbol
        function getCurrentAccidental() {
            return accidentalOptions[accidentalIndex];
        }

        // Update the selected chord display
        function updateSelectedChord() {
            const display = document.getElementById("current-chord-display");
            const addButton = document.querySelector(".add-chord-btn");

            if (!selectedLetter) {
                display.textContent = "â€”";
                addButton.disabled = true;
                return;
            }

            const chord = selectedLetter + getCurrentAccidental() + selectedType;
            display.textContent = chord;
            addButton.disabled = !currentMeasure;
        }

        // Render root note buttons
        function renderRootButtons() {
            const container = document.getElementById("root-letters");
            container.innerHTML = "";

            rootLetters.forEach(letter => {
                const btn = document.createElement("div");
                btn.className = "chord-btn";
                btn.textContent = letter + getCurrentAccidental();

                if (selectedLetter === letter) {
                    btn.classList.add("selected");
                }

                btn.onclick = () => {
                    selectedLetter = letter;
                    updateSelectedChord();
                    renderRootButtons();
                };

                container.appendChild(btn);
            });
        }

        // Render chord type buttons
        function renderTypeButtons() {
            const container = document.getElementById("chord-types");
            container.innerHTML = "";

            chordTypes.forEach(type => {
                const btn = document.createElement("div");
                btn.className = "chord-btn";
                btn.textContent = type || "×¨×’×™×œ";

                if (selectedType === type) {
                    btn.classList.add("selected");
                }

                btn.onclick = () => {
                    selectedType = type;
                    updateSelectedChord();
                    renderTypeButtons();
                };

                container.appendChild(btn);
            });
        }

        // Toggle accidental (natural, sharp, flat)
        function toggleAccidental() {
            accidentalIndex = (accidentalIndex + 1) % accidentalOptions.length;
            updateAccidentalButton();
            updateSelectedChord();
            renderRootButtons();
        }

        // Update accidental button text
        function updateAccidentalButton() {
            const button = document.getElementById("toggle-accidental");
            const labels = {
                "": "â™® ×œ×œ× ×¡×™××Ÿ",
                "#": "â™¯ ×“×™××–",
                "b": "â™­ ×‘××•×œ"
            };
            button.textContent = labels[getCurrentAccidental()];
        }

        // Create a new empty measure
        function createNewMeasure() {
            const beats = parseInt(document.getElementById("measure-beats").value);
            if (isNaN(beats) || beats < 1) {
                alert("×™×© ×œ×”×–×™×Ÿ ××¡×¤×¨ × ×§×™×©×•×ª ×ª×§×™×Ÿ");
                return;
            }

            currentMeasure = {
                beats: beats,
                chords: []
            };

            selectedChordIndex = -1;
            renderCurrentMeasure();
            updateButtons();
        }

        // Add selected chord to current measure
        function addChordToCurrentMeasure() {
            if (!currentMeasure) {
                alert("×™×© ×œ×™×¦×•×¨ ×ª×™×‘×” ×§×•×“×");
                return;
            }

            if (!selectedLetter) {
                alert("×™×© ×œ×‘×—×•×¨ ××§×•×¨×“");
                return;
            }

            const chordName = selectedLetter + getCurrentAccidental() + selectedType;

            // Calculate remaining space
            const usedBeats = currentMeasure.chords.reduce((sum, chord) => sum + chord.width, 0);
            const remainingBeats = currentMeasure.beats - usedBeats;

            if (remainingBeats < 0.25) {
                alert("×”×ª×™×‘×” ××œ××” - ××™×Ÿ ××§×•× ×œ××§×•×¨×“ × ×•×¡×£");
                return;
            }

            // Add new chord with minimum width
            const newWidth = Math.min(1, remainingBeats);
            currentMeasure.chords.push({
                chord: chordName,
                width: newWidth
            });

            renderCurrentMeasure();
            updateButtons();
        }

        // Remove chord from current measure
        function removeChordFromMeasure(index) {
            if (!currentMeasure || index < 0 || index >= currentMeasure.chords.length) return;

            currentMeasure.chords.splice(index, 1);
            selectedChordIndex = -1;

            renderCurrentMeasure();
            updateButtons();
        }

        // Select chord in measure
        function selectChordInMeasure(index) {
            selectedChordIndex = selectedChordIndex === index ? -1 : index;
            renderCurrentMeasure();
        }

        // Clear current measure
        function clearCurrentMeasure() {
            if (!currentMeasure) return;

            currentMeasure.chords = [];
            selectedChordIndex = -1;
            renderCurrentMeasure();
            updateButtons();
        }

        // Update button states
        function updateButtons() {
            const addToLineBtn = document.getElementById("add-to-line-btn");
            const clearBtn = document.getElementById("clear-measure-btn");

            addToLineBtn.disabled = !currentMeasure || currentMeasure.chords.length === 0;
            clearBtn.disabled = !currentMeasure || currentMeasure.chords.length === 0;

            document.querySelector(".add-chord-btn").disabled = !currentMeasure || !selectedLetter;
        }

        // Render current measure being built
        function renderCurrentMeasure() {
            const container = document.getElementById("current-measure-container");

            if (!currentMeasure) {
                container.innerHTML = '<div class="measure-placeholder"><p>ğŸ‘ˆ ×œ×—×¥ "×¦×•×¨ ×ª×™×‘×” ×—×“×©×”" ×›×“×™ ×œ×”×ª×—×™×œ</p></div>';
                return;
            }

            if (currentMeasure.chords.length === 0) {
                container.innerHTML = '<div class="measure-placeholder"><p>ğŸµ ×”×•×¡×£ ××§×•×¨×“×™× ×œ×ª×™×‘×”</p></div>';
                return;
            }

            const measureDiv = document.createElement("div");
            measureDiv.className = "measure-preview";

            // Calculate flex basis for each chord
            const totalBeats = currentMeasure.beats;

            currentMeasure.chords.forEach((chord, index) => {
                // Create chord element
                const chordDiv = document.createElement("div");
                chordDiv.className = "chord-in-measure";
                if (selectedChordIndex === index) {
                    chordDiv.classList.add("selected");
                }

                const flexBasis = (chord.width / totalBeats) * 100;
                chordDiv.style.flexBasis = `${flexBasis}%`;
                chordDiv.style.flexGrow = '0';
                chordDiv.style.flexShrink = '0';

                chordDiv.innerHTML = `
                    <div class="chord-name">${chord.chord}</div>
                    <div class="chord-beats">${chord.width.toFixed(2)} × ×§×™×©×•×ª</div>
                    <button class="chord-remove" onclick="removeChordFromMeasure(${index}); event.stopPropagation();">Ã—</button>
                `;

                // Add click to select chord
                chordDiv.onclick = (e) => {
                    e.stopPropagation();
                    selectChordInMeasure(index);
                };

                // Add double-click to edit width
                chordDiv.ondblclick = (e) => {
                    e.stopPropagation();
                    editChordWidth(index);
                };

                measureDiv.appendChild(chordDiv);

                // Add resize handle (except for last chord)
                if (index < currentMeasure.chords.length - 1) {
                    const handle = document.createElement("div");
                    handle.className = "resize-handle";
                    handle.onmousedown = (e) => startResize(e, index);
                    measureDiv.appendChild(handle);
                }
            });

            // Show remaining space info
            const usedBeats = currentMeasure.chords.reduce((sum, chord) => sum + chord.width, 0);
            const remainingBeats = currentMeasure.beats - usedBeats;

            if (remainingBeats > 0.01) {
                const spacerDiv = document.createElement("div");
                spacerDiv.style.flexBasis = `${(remainingBeats / totalBeats) * 100}%`;
                spacerDiv.style.border = "2px dashed #ccc";
                spacerDiv.style.borderRadius = "8px";
                spacerDiv.style.display = "flex";
                spacerDiv.style.alignItems = "center";
                spacerDiv.style.justifyContent = "center";
                spacerDiv.style.color = "#999";
                spacerDiv.style.fontSize = "12px";
                spacerDiv.style.margin = "0 1px";
                spacerDiv.textContent = `${remainingBeats.toFixed(2)} × ×§×™×©×•×ª ×¤× ×•×™×•×ª`;
                measureDiv.appendChild(spacerDiv);
            }

            container.innerHTML = "";
            container.appendChild(measureDiv);
        }

        // Edit chord width with popup
        function editChordWidth(index) {
            if (!currentMeasure || index < 0 || index >= currentMeasure.chords.length) return;

            const chord = currentMeasure.chords[index];
            const newWidth = prompt(`×”×–×Ÿ ×¨×•×—×‘ ×—×“×© ×œ××§×•×¨×“ ${chord.chord} (× ×§×™×©×•×ª):`, chord.width.toFixed(2));

            if (newWidth === null) return; // User cancelled

            const width = parseFloat(newWidth);
            if (isNaN(width) || width <= 0) {
                alert("×™×© ×œ×”×–×™×Ÿ ××¡×¤×¨ ×—×™×•×‘×™");
                return;
            }

            // Check if total doesn't exceed measure beats
            const otherChordsWidth = currentMeasure.chords
                .filter((_, i) => i !== index)
                .reduce((sum, c) => sum + c.width, 0);

            if (otherChordsWidth + width > currentMeasure.beats) {
                alert(`×”×¨×•×—×‘ ×’×“×•×œ ××“×™. ××§×¡×™××•×: ${(currentMeasure.beats - otherChordsWidth).toFixed(2)}`);
                return;
            }

            chord.width = width;
            renderCurrentMeasure();
        }

        // Start resize operation
        function startResize(e, index) {
            e.preventDefault();
            e.stopPropagation();

            isDragging = true;
            dragIndex = index;
            startX = e.clientX;

            originalWidths = currentMeasure.chords.map(chord => chord.width);

            const handle = e.target;
            handle.classList.add('dragging');

            document.addEventListener("mousemove", onResize);
            document.addEventListener("mouseup", stopResize);

            document.body.style.cursor = "ew-resize";
        }

        // Handle resize dragging
        function onResize(e) {
            if (!isDragging || dragIndex === null) return;

            const deltaX = e.clientX - startX;
            const container = document.querySelector(".measure-preview");
            const containerWidth = container.offsetWidth - 30; // Account for padding
            const deltaBeats = (deltaX / containerWidth) * currentMeasure.beats;

            const leftChord = currentMeasure.chords[dragIndex];
            const rightChord = currentMeasure.chords[dragIndex + 1];

            const newLeftWidth = originalWidths[dragIndex] + deltaBeats;
            const newRightWidth = originalWidths[dragIndex + 1] - deltaBeats;

            // Ensure minimum widths
            const minWidth = 0.25;
            if (newLeftWidth >= minWidth && newRightWidth >= minWidth) {
                leftChord.width = Math.round(newLeftWidth * 100) / 100; // Round to 2 decimal places
                rightChord.width = Math.round(newRightWidth * 100) / 100;
                renderCurrentMeasure();
            }
        }

        // Stop resize operation
        function stopResize() {
            isDragging = false;
            dragIndex = null;

            document.body.style.cursor = "";
            document.querySelectorAll('.resize-handle').forEach(handle => {
                handle.classList.remove('dragging');
            });

            document.removeEventListener("mousemove", onResize);
            document.removeEventListener("mouseup", stopResize);
        }

        // Add current measure to current line
        function addMeasureToLine() {
            if (!currentMeasure || currentMeasure.chords.length === 0) {
                alert("××™×Ÿ ×ª×™×‘×” ×œ×”×•×¡×¤×”");
                return;
            }

            // Add to current line (last line)
            songStructure[songStructure.length - 1].push({...currentMeasure});

            // Reset current measure
            currentMeasure = null;
            selectedChordIndex = -1;
            renderCurrentMeasure();
            renderSongStructure();
            updateButtons();
        }

        // Create new line
        function createNewLine() {
            songStructure.push([]);
            renderSongStructure();
        }

        // Render the entire song structure
        function renderSongStructure() {
            const container = document.getElementById("song-lines");
            container.innerHTML = "";

            songStructure.forEach((line, lineIndex) => {
                if (line.length === 0 && lineIndex === songStructure.length - 1) {
                    // Don't show empty last line
                    return;
                }

                const lineDiv = document.createElement("div");
                lineDiv.className = "song-line";

                if (line.length === 0) {
                    lineDiv.innerHTML = '<p style="color: #999; font-style: italic;">×©×•×¨×” ×¨×™×§×”</p>';
                } else {
                    line.forEach((measure) => {
                        const measureDiv = document.createElement("div");
                        measureDiv.className = "measure-in-line";

                        measure.chords.forEach(chord => {
                            const chordDiv = document.createElement("div");
                            chordDiv.className = "chord-in-measure";
                            chordDiv.style.flex = chord.width;
                            chordDiv.innerHTML = `
                                <div class="chord-name">${chord.chord}</div>
                                <div class="chord-beats">${chord.width.toFixed(1)}</div>
                            `;
                            measureDiv.appendChild(chordDiv);
                        });

                        lineDiv.appendChild(measureDiv);
                    });
                }

                container.appendChild(lineDiv);
            });
        }

            function finishAndReturn() {
                // Convert song structure into flat chord lines
                const chordLines = songStructure.filter(line => line.length > 0).map(line => {
                    return line.flatMap(measure =>
                        measure.chords.map(chord => ({
                            chord: chord.chord,
                            beats: chord.width,
                            label: ""
                        }))
                    );
                });

                try {
                    // Save chord data to localStorage
                    localStorage.setItem("chords", JSON.stringify(chordLines));
                    localStorage.setItem("justReturnedFromChords", "true");
                } catch (e) {
                    console.log("localStorage not available - data stored in memory only");
                }

                // Navigate to the add song page
                window.location.href = "/add_song";
            }


        // Keyboard shortcuts
        function handleKeydown(e) {
            if (!currentMeasure) return;

            // Delete selected chord
            if (e.key === 'Delete' && selectedChordIndex >= 0) {
                removeChordFromMeasure(selectedChordIndex);
            }

            // Navigate between chords
            if (e.key === 'ArrowLeft' && currentMeasure.chords.length > 0) {
                selectedChordIndex = selectedChordIndex <= 0 ?
                    currentMeasure.chords.length - 1 : selectedChordIndex - 1;
                renderCurrentMeasure();
            }

            if (e.key === 'ArrowRight' && currentMeasure.chords.length > 0) {
                selectedChordIndex = selectedChordIndex >= currentMeasure.chords.length - 1 ?
                    0 : selectedChordIndex + 1;
                renderCurrentMeasure();
            }

            // Add chord with Enter
            if (e.key === 'Enter' && selectedLetter) {
                addChordToCurrentMeasure();
            }
        }

        // Event listeners
        document.addEventListener("DOMContentLoaded", () => {
            init();

            // Setup accidental toggle
            document.getElementById("toggle-accidental").onclick = toggleAccidental;

            // Add keyboard support
            document.addEventListener("keydown", handleKeydown);

            // Prevent context menu on right click for better UX
            document.addEventListener("contextmenu", (e) => {
                if (e.target.closest('.measure-preview')) {
                    e.preventDefault();
                }
            });
        });

        // Touch support for mobile
        let touchStartX = 0;
        let touchStartTime = 0;

        function handleTouchStart(e, index) {
            touchStartX = e.touches[0].clientX;
            touchStartTime = Date.now();
        }

        function handleTouchEnd(e, index) {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndTime = Date.now();
            const deltaX = Math.abs(touchEndX - touchStartX);
            const deltaTime = touchEndTime - touchStartTime;

            // If it's a tap (not a swipe), select the chord
            if (deltaX < 10 && deltaTime < 300) {
                selectChordInMeasure(index);
            }
        }
    </script>
</body>
</html>
