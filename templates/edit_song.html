{% extends "base.html" %}

{% block title %}×¢×¨×™×›×ª ×©×™×¨ - {{ song.title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/song_form.css') }}">
{% endblock %}

{% block content %}
<div class="edit-song-container">
    <div class="edit-song-card">
        <!-- Header -->
        <div class="page-header">
            <h1 class="page-title">âœï¸ ×¢×¨×™×›×ª ×©×™×¨ ğŸ¶</h1>
            <p class="page-subtitle">×¢×¨×•×š ××ª ×¤×¨×˜×™ ×”×©×™×¨ ×•×”××§×•×¨×“×™×</p>
        </div>

        <!-- Current Song Info -->
        <div class="song-info">
            <h3>ğŸµ {{ song.title }} - {{ song.artist }}</h3>
            <p><strong>×¡×•×œ× × ×•×›×—×™:</strong> {{ song.key }} ({{ song.key_type }})</p>
            <p><strong>××§×¦×‘:</strong> {{ song.time_signature }} | <strong>BPM:</strong> {{ song.bpm }}</p>
        </div>

        <form id="edit-song-form">
            <input type="hidden" id="song_id" name="song_id" value="{{ song.id }}">

            <div class="form-grid">
                <!-- Basic Info Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        <span class="section-icon">ğŸ“</span>
                        ×¤×¨×˜×™× ×‘×¡×™×¡×™×™×
                    </h3>

                    <div class="form-group">
                        <label class="form-label" for="title">
                            <span class="label-icon">ğŸµ</span>
                            ×©× ×”×©×™×¨
                        </label>
                        <input type="text" id="title" name="title" class="form-input" required
                               value="{{ song.title }}" placeholder="×”×›× ×¡ ××ª ×©× ×”×©×™×¨...">
                        <div class="field-validation" id="title-validation"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="artist">
                            <span class="label-icon">ğŸ¤</span>
                            ×©× ×”×××Ÿ
                        </label>
                        <input type="text" id="artist" name="artist" class="form-input" required
                               value="{{ song.artist }}" placeholder="×”×›× ×¡ ××ª ×©× ×”×××Ÿ...">
                        <div class="field-validation" id="artist-validation"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="genre">
                            <span class="label-icon">ğŸ­</span>
                            ×–'×× ×¨×™× ××•×–×™×§×œ×™×™×
                        </label>
                        <div class="multi-genre-container">
                            <select id="genre" name="genre" class="form-select">
                                <option value="">×‘×—×¨ ×–'×× ×¨</option>
                                <option value="pop">×¤×•×¤ - Pop</option>
                                <option value="rock">×¨×•×§ - Rock</option>
                                <option value="jazz">×’'××– - Jazz</option>
                                <option value="blues">×‘×œ×•×– - Blues</option>
                                <option value="classical">×§×œ××¡×™ - Classical</option>
                                <option value="folk">×¤×•×œ×§ - Folk</option>
                                <option value="country">×§×× ×˜×¨×™ - Country</option>
                                <option value="reggae">×¨×’×™×™ - Reggae</option>
                                <option value="electronic">××œ×§×˜×¨×•× ×™ - Electronic</option>
                                <option value="hip_hop">×”×™×¤ ×”×•×¤ - Hip Hop</option>
                                <option value="r_and_b">R&B - ×¨×™×ª× ×× ×“ ×‘×œ×•×–</option>
                                <option value="soul">×¡×•×œ - Soul</option>
                                <option value="funk">×¤×× ×§ - Funk</option>
                                <option value="metal">××˜××œ - Metal</option>
                                <option value="punk">×¤×× ×§ - Punk</option>
                                <option value="alternative">××œ×˜×¨× ×˜×™×‘ - Alternative</option>
                                <option value="indie">××™× ×“×™ - Indie</option>
                                <option value="world">××•Ø²×™×§×ª ×¢×•×œ× - World Music</option>
                                <option value="mizrahi">××–×¨×—×™</option>
                                <option value="israeli">×™×©×¨××œ×™</option>
                                <option value="other">××—×¨</option>
                            </select>
                            <button type="button" class="add-genre-btn" id="add-genre-btn">
                                <span>â•</span>
                            </button>
                        </div>

                        <div class="selected-genres" id="selected-genres">
                            <!-- ×›××Ÿ ×™×•×¤×™×¢×• ×”×–'×× ×¨×™× ×©× ×‘×—×¨×• -->
                        </div>

                        <input type="hidden" id="genres-list" name="genres" required>

                        <div class="field-validation" id="genre-validation"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="song_version">
                            <span class="label-icon">ğŸ¬</span>
                            ×’×¨×¡×ª ×”×©×™×¨
                        </label>
                        <select id="song_version" name="song_version" class="form-select">
                            <option value="">×‘×—×¨ ×’×¨×¡×”</option>
                            <option value="original" {% if song.get('song_version') == 'original' %}selected{% endif %}>×’×¨×¡×ª ××œ×‘×•× (××§×•×¨×™×ª)</option>
                            <option value="cover" {% if song.get('song_version') == 'cover' %}selected{% endif %}>×§××‘×¨ ×©×œ ×××Ÿ ××—×¨</option>
                            <option value="live" {% if song.get('song_version') == 'live' %}selected{% endif %}>×’×¨×¡×ª ×”×•×¤×¢×” ×—×™×”</option>
                        </select>
                        <div class="field-validation" id="song_version-validation"></div>
                    </div>

                    <div class="form-group" id="original_artist_group" style="display: {% if song.get('song_version') == 'cover' %}block{% else %}none{% endif %};">
                        <label class="form-label" for="original_artist">
                            <span class="label-icon">ğŸ¤</span>
                            ×©× ×”×××Ÿ ×”××§×•×¨×™
                        </label>
                        <input type="text" id="original_artist" name="original_artist" class="form-input"
                               value="{{ song.get('original_artist', '') }}" placeholder="×”×›× ×¡ ××ª ×©× ×”×××Ÿ ×”××§×•×¨×™...">
                        <div class="input-hint">×©× ×”×××Ÿ ×”××§×•×¨×™ ×©×œ ×”×©×™×¨ (×œ×× ×™×¢×ª ×‘×¢×™×•×ª ×–×›×•×™×•×ª ×™×•×¦×¨×™×)</div>
                        <div class="field-validation" id="original_artist-validation"></div>
                    </div>
                </div>

                <!-- Musical Details Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        <span class="section-icon">ğŸ¼</span>
                        ×¤×¨×˜×™× ××•×–×™×§×œ×™×™×
                    </h3>

                    <div class="form-group">
                        <label class="form-label" for="key">
                            <span class="label-icon">ğŸ”‘</span>
                            ×¡×•×œ×
                        </label>
                        <select id="key" name="key" class="form-select" required>
                            <option value="">×‘×—×¨ ×¡×•×œ×</option>
                            <option value="C" {% if song.key == 'C' %}selected{% endif %}>×“×• - C</option>
                            <option value="C#" {% if song.key == 'C#' %}selected{% endif %}>×“×• ×“×™××– - C#</option>
                            <option value="Db" {% if song.key == 'Db' %}selected{% endif %}>×¨×” ×‘××•×œ - Db</option>
                            <option value="D" {% if song.key == 'D' %}selected{% endif %}>×¨×” - D</option>
                            <option value="D#" {% if song.key == 'D#' %}selected{% endif %}>×¨×” ×“×™××– - D#</option>
                            <option value="Eb" {% if song.key == 'Eb' %}selected{% endif %}>××™ ×‘××•×œ - Eb</option>
                            <option value="E" {% if song.key == 'E' %}selected{% endif %}>××™ - E</option>
                            <option value="F" {% if song.key == 'F' %}selected{% endif %}>×¤×” - F</option>
                            <option value="F#" {% if song.key == 'F#' %}selected{% endif %}>×¤×” ×“×™××– - F#</option>
                            <option value="Gb" {% if song.key == 'Gb' %}selected{% endif %}>×¡×•×œ ×‘××•×œ - Gb</option>
                            <option value="G" {% if song.key == 'G' %}selected{% endif %}>×¡×•×œ - G</option>
                            <option value="G#" {% if song.key == 'G#' %}selected{% endif %}>×¡×•×œ ×“×™××– - G#</option>
                            <option value="Ab" {% if song.key == 'Ab' %}selected{% endif %}>×œ×” ×‘××•×œ - Ab</option>
                            <option value="A" {% if song.key == 'A' %}selected{% endif %}>×œ×” - A</option>
                            <option value="A#" {% if song.key == 'A#' %}selected{% endif %}>×œ×” ×“×™××– - A#</option>
                            <option value="Bb" {% if song.key == 'Bb' %}selected{% endif %}>×¡×™ ×‘××•×œ - Bb</option>
                            <option value="B" {% if song.key == 'B' %}selected{% endif %}>×¡×™ - B</option>
                        </select>
                        <div class="field-validation" id="key-validation"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="key_type">
                            <span class="label-icon">ğŸ¹</span>
                            ×¡×•×’ ×¡×•×œ×
                        </label>
                        <select id="key_type" name="key_type" class="form-select" required>
                            <option value="">×‘×—×¨ ×¡×•×’</option>
                            <option value="major" {% if song.key_type == 'major' %}selected{% endif %}>××–'×•×¨ - Major</option>
                            <option value="natural_minor" {% if song.key_type == 'natural_minor' %}selected{% endif %}>××™× ×•×¨ ×˜×‘×¢×™ - Natural Minor</option>
                            <option value="harmonic_minor" {% if song.key_type == 'harmonic_minor' %}selected{% endif %}>××™× ×•×¨ ×”×¨××•× ×™ - Harmonic Minor</option>
                            <option value="melodic_minor" {% if song.key_type == 'melodic_minor' %}selected{% endif %}>××™× ×•×¨ ××œ×•×“×™ - Melodic Minor</option>
                            <option value="ionian" {% if song.key_type == 'ionian' %}selected{% endif %}>×™×•Ö¹× ×™ - Ionian</option>
                            <option value="dorian" {% if song.key_type == 'dorian' %}selected{% endif %}>×“×•Ö¹×¨×™ - Dorian</option>
                            <option value="phrygian" {% if song.key_type == 'phrygian' %}selected{% endif %}>×¤×¨×™×’×™ - Phrygian</option>
                            <option value="lydian" {% if song.key_type == 'lydian' %}selected{% endif %}>×œ×™×“×™ - Lydian</option>
                            <option value="mixolydian" {% if song.key_type == 'mixolydian' %}selected{% endif %}>××™×§×¡×•×œ×™×“×™ - Mixolydian</option>
                            <option value="aeolian" {% if song.key_type == 'aeolian' %}selected{% endif %}>×××•×œ×™ - Aeolian</option>
                            <option value="locrian" {% if song.key_type == 'locrian' %}selected{% endif %}>×œ×•Ö¹×§×¨×™ - Locrian</option>
                            <option value="major_pentatonic" {% if song.key_type == 'major_pentatonic' %}selected{% endif %}>×¤× ×˜×˜×•× ×™ ××–'×•×¨×™ - Major Pentatonic</option>
                            <option value="minor_pentatonic" {% if song.key_type == 'minor_pentatonic' %}selected{% endif %}>×¤× ×˜×˜×•× ×™ ××™× ×•×¨×™ - Minor Pentatonic</option>
                            <option value="chromatic" {% if song.key_type == 'chromatic' %}selected{% endif %}>×›×¨×•××˜×™ - Chromatic</option>
                            <option value="whole_tone" {% if song.key_type == 'whole_tone' %}selected{% endif %}>×©×œ× ×˜×•× ×™× - Whole Tone</option>
                            <option value="blues" {% if song.key_type == 'blues' %}selected{% endif %}>×‘×œ×•×– - Blues</option>
                            <option value="octatonic" {% if song.key_type == 'octatonic' %}selected{% endif %}>××•×§×˜×˜×•× ×™ / ×“×™××™× ×™×©×“ - Octatonic / Diminished</option>
                        </select>
                        <div class="field-validation" id="key_type-validation"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="difficulty">
                            <span class="label-icon">â­</span>
                            ×¨××ª ×§×•×©×™
                        </label>
                        <select id="difficulty" name="difficulty" class="form-select" required>
                            <option value="">×‘×—×¨ ×¨××ª ×§×•×©×™</option>
                            <option value="beginner" {% if song.difficulty == 'beginner' %}selected{% endif %}>××ª×—×™×œ×™×</option>
                            <option value="intermediate" {% if song.difficulty == 'intermediate' %}selected{% endif %}>×‘×™× ×™×™×</option>
                            <option value="advanced" {% if song.difficulty == 'advanced' %}selected{% endif %}>××ª×§×“××™×</option>
                        </select>
                        <div class="field-validation" id="difficulty-validation"></div>
                    </div>
                </div>

                <!-- Timing Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        <span class="section-icon">â±ï¸</span>
                        ××§×¦×‘ ×•×§×¦×‘
                    </h3>

                    <div class="form-group">
                        <label class="form-label" for="time_signature">
                            <span class="label-icon">ğŸµ</span>
                            ××§×¦×‘
                        </label>
                        <select id="time_signature" name="time_signature" class="form-select" required>
                            <option value="">×‘×—×¨ ××§×¦×‘</option>
                            <option value="4/4" {% if song.time_signature == '4/4' %}selected{% endif %}>4/4 (×”× ×¤×•×¥ ×‘×™×•×ª×¨)</option>
                            <option value="2/4" {% if song.time_signature == '2/4' %}selected{% endif %}>2/4</option>
                            <option value="3/4" {% if song.time_signature == '3/4' %}selected{% endif %}>3/4 (×•×œ×¡)</option>
                            <option value="2/2" {% if song.time_signature == '2/2' %}selected{% endif %}>2/2 (Alla Breve)</option>
                            <option value="3/2" {% if song.time_signature == '3/2' %}selected{% endif %}>3/2</option>
                            <option value="3/8" {% if song.time_signature == '3/8' %}selected{% endif %}>3/8</option>
                            <option value="6/8" {% if song.time_signature == '6/8' %}selected{% endif %}>6/8 (×‘×œ×•×–/×©×™×¨×™× ×§×¦×‘×™×™×)</option>
                            <option value="9/8" {% if song.time_signature == '9/8' %}selected{% endif %}>9/8</option>
                            <option value="12/8" {% if song.time_signature == '12/8' %}selected{% endif %}>12/8 (×‘×œ×•×–/×’×•×¡×¤×œ)</option>
                            <option value="6/4" {% if song.time_signature == '6/4' %}selected{% endif %}>6/4</option>
                            <option value="9/4" {% if song.time_signature == '9/4' %}selected{% endif %}>9/4</option>
                            <option value="12/4" {% if song.time_signature == '12/4' %}selected{% endif %}>12/4</option>
                            <option value="5/4" {% if song.time_signature == '5/4' %}selected{% endif %}>5/4 (×œ× ×©×’×¨×ª×™)</option>
                            <option value="5/8" {% if song.time_signature == '5/8' %}selected{% endif %}>5/8</option>
                            <option value="7/4" {% if song.time_signature == '7/4' %}selected{% endif %}>7/4</option>
                            <option value="7/8" {% if song.time_signature == '7/8' %}selected{% endif %}>7/8 (××ª×§×“×/××ª× ×™)</option>
                            <option value="11/4" {% if song.time_signature == '11/4' %}selected{% endif %}>11/4</option>
                            <option value="11/8" {% if song.time_signature == '11/8' %}selected{% endif %}>11/8</option>
                            <option value="13/4" {% if song.time_signature == '13/4' %}selected{% endif %}>13/4</option>
                            <option value="13/8" {% if song.time_signature == '13/8' %}selected{% endif %}>13/8</option>
                        </select>
                        <div class="field-validation" id="time_signature-validation"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="bpm">
                            <span class="label-icon">ğŸš€</span>
                            BPM (××”×™×¨×•×ª)
                        </label>
                        <input type="number" id="bpm" name="bpm" class="form-input" required
                               min="40" max="200" step="1" value="{{ song.bpm }}"
                               placeholder="100">
                        <div class="input-hint">××”×™×¨×•×ª ×”×§×¦×‘ ×‘×™×Ÿ 40-200 ×¤×¢×™××•×ª ×œ×“×§×”</div>
                        <div class="field-validation" id="bpm-validation"></div>
                    </div>
                </div>

                <!-- Media Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        <span class="section-icon">ğŸ“º</span>
                        ××“×™×”
                    </h3>

                    <div class="form-group">
                        <label class="form-label" for="video_url">
                            <span class="label-icon">ğŸ¥</span>
                            ×§×™×©×•×¨ ×œ×¡×¨×˜×•×Ÿ
                        </label>
                        <input type="text" id="video_url" name="video_url" class="form-input" required
                               value="{{ song.video_url }}" placeholder="https://www.youtube.com/watch?v=...">
                        <div class="input-hint">×§×™×©×•×¨ ×™×•×˜×™×•×‘ ××• ×§×™×©×•×¨ ×™×©×™×¨ ×œ×¡×¨×˜×•×Ÿ</div>
                        <div class="field-validation" id="video_url-validation"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="tutorial_video_url">
                            <span class="label-icon">ğŸ“š</span>
                            ×§×™×©×•×¨ ×œ×¡×¨×˜×•×Ÿ ×”×“×¨×›×”
                        </label>
                        <input type="text" id="tutorial_video_url" name="tutorial_video_url" class="form-input"
                               value="{{ song.get('tutorial_video_url', '') }}" placeholder="https://www.youtube.com/watch?v=...">
                        <div class="input-hint">×§×™×©×•×¨ ×™×•×˜×™×•×‘ ×œ×¡×¨×˜×•×Ÿ ×”×“×¨×›×” (××•×¤×¦×™×•× ×œ×™)</div>
                        <div class="field-validation" id="tutorial_video_url-validation"></div>
                    </div>
                </div>

                <!-- Chords Section -->
                <div class="form-section full-width-section chords-section">
                    <h3 class="section-title">
                        <span class="section-icon">ğŸ¸</span>
                        ××§×•×¨×“×™×
                    </h3>

                    <div class="chords-status">
                        <div id="chords-success" class="success-message" style="display:none;">
                            <span>ğŸ¶</span>
                            <span>×”××§×•×¨×“×™× ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”!</span>
                        </div>
                    </div>

                    <button type="button" class="chords-btn" id="chords-btn" onclick="editChords()">
                        <span>ğŸ¸</span>
                        <span>×¢×¨×•×š ××§×•×¨×“×™×</span>
                    </button>

                    <input type="hidden" id="chords" name="chords" required>
                    <input type="hidden" id="loops" name="loops">
                </div>

                <!-- Notes Section -->
                <div class="form-section full-width-section">
                    <h3 class="section-title">
                        <span class="section-icon">ğŸ“</span>
                        ×”×¢×¨×•×ª
                    </h3>

                    <div class="form-group">
                        <label class="form-label" for="notes">
                            <span class="label-icon">ğŸ’¬</span>
                            ×”×¢×¨×•×ª ×œ××•×¨×”
                        </label>
                        <textarea id="notes" name="notes" class="form-input" rows="4"
                                  placeholder="×”×›× ×¡ ×”×¢×¨×•×ª ×—×©×•×‘×•×ª ×¢×œ ×”×©×™×¨, ×“×’×©×™× ××™×•×—×“×™×, ××• ××™×“×¢ × ×•×¡×£ ×©×™×›×•×œ ×œ×¢×–×•×¨...">{{ song.get('notes', '') }}</textarea>
                        <div class="input-hint">×”×¢×¨×•×ª ×©×™×›×•×œ×•×ª ×œ×¢×–×•×¨ ×œ××•×¨×™× ××—×¨×™× ×œ×”×‘×™×Ÿ ××ª ×”×©×™×¨ ×˜×•×‘ ×™×•×ª×¨</div>
                        <div class="field-validation" id="notes-validation"></div>
                    </div>
                </div>
            </div>

            <!-- Actions Section -->
            <div class="actions-section">
                <button type="submit" class="submit-btn">
                    <span>ğŸ’¾</span>
                    <span>×©××•×¨ ×©×™× ×•×™×™×</span>
                </button>
                <a href="{{ url_for('songs.play_song', song_id=song.id) }}" class="cancel-btn">
                    <span>âŒ</span>
                    <span>×‘×™×˜×•×œ</span>
                </a>
            </div>
        </form>

        <div id="response-message" class="response-message" style="display: none;"></div>
    </div>
</div>

<script>
    // Pass data from Flask to JavaScript
    const songId = "{{ song.id }}";
    const existingChords = {{ song.chords | tojson }};
    const existingLoops = {{ song.loops | tojson }};

    // Load existing genres (support both old single genre and new multiple genres)
    let existingGenres = [];
    {% if song.genres %}
        // New multiple genres format
        {% if song.genres is iterable and song.genres is not string %}
            existingGenres = {{ song.genres | tojson }};
        {% else %}
            // Handle case where genres is a string (shouldn't happen with new format)
            existingGenres = [{{ song.genres | tojson }}];
        {% endif %}
    {% elif song.genre %}
        // Old single genre format - convert to array
        existingGenres = [{{ song.genre | tojson }}];
    {% endif %}

    // Set existing data in hidden fields
    document.getElementById("chords").value = JSON.stringify(existingChords);
    document.getElementById("loops").value = JSON.stringify(existingLoops);

    // Store for editing context
    localStorage.setItem("editingSongId", songId);
    localStorage.setItem("chords", JSON.stringify(existingChords));
    localStorage.setItem("loops", JSON.stringify(existingLoops));

    // Clear any conflicting new song data
    localStorage.removeItem("addingNewSong");
    localStorage.removeItem("songData");

    // ×”××¨ embed URL ×—×–×¨×” ×œ-watch URL ×œ×ª×¦×•×’×”
    document.addEventListener("DOMContentLoaded", function() {
        const videoUrlField = document.getElementById("video_url");
        const currentUrl = videoUrlField.value;

        // ×× ×–×” embed URL, ×”××¨ ××•×ª×• ×—×–×¨×” ×œ-watch URL
        if (currentUrl.includes('/embed/')) {
            const videoId = currentUrl.split('/embed/')[1];
            videoUrlField.value = `https://www.youtube.com/watch?v=${videoId}`;
        }

        // Load existing genres after DOM is ready
        if (window.loadGenres && existingGenres.length > 0) {
            window.loadGenres(existingGenres);
        }

        // Handle song version change to show/hide original artist field
        const songVersionSelect = document.getElementById('song_version');
        const originalArtistGroup = document.getElementById('original_artist_group');
        const originalArtistInput = document.getElementById('original_artist');

        if (songVersionSelect && originalArtistGroup) {
            // Check initial value
            if (songVersionSelect.value === 'cover') {
                originalArtistGroup.style.display = 'block';
                if (originalArtistInput) originalArtistInput.required = true;
            }

            // Listen for changes
            songVersionSelect.addEventListener('change', function() {
                if (this.value === 'cover') {
                    originalArtistGroup.style.display = 'block';
                    if (originalArtistInput) originalArtistInput.required = true;
                } else {
                    originalArtistGroup.style.display = 'none';
                    if (originalArtistInput) {
                        originalArtistInput.required = false;
                        // Don't clear value when hidden - keep it for potential future use
                    }
                }
            });
        }
    });
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/song_form_manager.js') }}"></script>
{% endblock %}
