{% extends "base.html" %}

{% block title %}×¢×¨×™×›×ª ×©×™×¨ - {{ song.title }}{% endblock %}

{% block content %}
<div class="container">
    <h1>âœï¸ ×¢×¨×™×›×ª ×©×™×¨</h1>
    <form id="edit-song-form" class="styled-form">
        <input type="hidden" id="song_id" name="song_id" value="{{ song.id }}">

        <label for="title">×©× ×”×©×™×¨:</label>
        <input type="text" id="title" name="title" value="{{ song.title }}" required>

        <label for="artist">×©× ×”×××Ÿ:</label>
        <input type="text" id="artist" name="artist" value="{{ song.artist }}" required>

        <label for="key">×¡×•×œ×:</label>
        <select id="key" name="key" required>
            <option value="">×‘×—×¨ ×¡×•×œ×</option>
            <option value="C" {% if song.key == 'C' %}selected{% endif %}>×“×• - C</option>
            <option value="C#" {% if song.key == 'C#' %}selected{% endif %}>×“×• ×“×™××– - C#</option>
            <option value="Db" {% if song.key == 'Db' %}selected{% endif %}>×¨×” ×‘××•×œ - Db</option>
            <option value="D" {% if song.key == 'D' %}selected{% endif %}>×¨×” - D</option>
            <option value="D#" {% if song.key == 'D#' %}selected{% endif %}>×¨×” ×“×™××– - D#</option>
            <option value="Eb" {% if song.key == 'Eb' %}selected{% endif %}>××™ ×‘××•×œ - Eb</option>
            <option value="E" {% if song.key == 'E' %}selected{% endif %}>××™ - E</option>
            <option value="F" {% if song.key == 'F' %}selected{% endif %}>×¤×” - F</option>
            <option value="F#" {% if song.key == 'F#' %}selected{% endif %}>×¤×” ×“×™××– - F#</option>
            <option value="Gb" {% if song.key == 'Gb' %}selected{% endif %}>×¡×•×œ ×‘××•×œ - Gb</option>
            <option value="G" {% if song.key == 'G' %}selected{% endif %}>×¡×•×œ - G</option>
            <option value="G#" {% if song.key == 'G#' %}selected{% endif %}>×¡×•×œ ×“×™××– - G#</option>
            <option value="Ab" {% if song.key == 'Ab' %}selected{% endif %}>×œ×” ×‘××•×œ - Ab</option>
            <option value="A" {% if song.key == 'A' %}selected{% endif %}>×œ×” - A</option>
            <option value="A#" {% if song.key == 'A#' %}selected{% endif %}>×œ×” ×“×™××– - A#</option>
            <option value="Bb" {% if song.key == 'Bb' %}selected{% endif %}>×¡×™ ×‘××•×œ - Bb</option>
            <option value="B" {% if song.key == 'B' %}selected{% endif %}>×¡×™ - B</option>
        </select>
        <label for="key_type">×¡×•×’ ×¡×•×œ×:</label>
        <select id="key_type" name="key_type" required>
            <option value="">×‘×—×¨ ×¡×•×’</option>
            <option value="major" {% if song.key_type == 'major' %}selected{% endif %}>××–'×•×¨ - Major</option>
            <option value="natural_minor" {% if song.key_type == 'natural_minor' %}selected{% endif %}>××™× ×•×¨ ×˜×‘×¢×™ - Natural Minor</option>
            <option value="harmonic_minor" {% if song.key_type == 'harmonic_minor' %}selected{% endif %}>××™× ×•×¨ ×”×¨××•× ×™ - Harmonic Minor</option>
            <option value="melodic_minor" {% if song.key_type == 'melodic_minor' %}selected{% endif %}>××™× ×•×¨ ××œ×•×“×™ - Melodic Minor</option>

            <option value="ionian" {% if song.key_type == 'ionian' %}selected{% endif %}>×™×•Ö¹× ×™ - Ionian</option>
            <option value="dorian" {% if song.key_type == 'dorian' %}selected{% endif %}>×“×•Ö¹×¨×™ - Dorian</option>
            <option value="phrygian" {% if song.key_type == 'phrygian' %}selected{% endif %}>×¤×¨×™×’×™ - Phrygian</option>
            <option value="lydian" {% if song.key_type == 'lydian' %}selected{% endif %}>×œ×™×“×™ - Lydian</option>
            <option value="mixolydian" {% if song.key_type == 'mixolydian' %}selected{% endif %}>××™×§×¡×•×œ×™×“×™ - Mixolydian</option>
            <option value="aeolian" {% if song.key_type == 'aeolian' %}selected{% endif %}>×××•×œ×™ - Aeolian</option>
            <option value="locrian" {% if song.key_type == 'locrian' %}selected{% endif %}>×œ×•Ö¹×§×¨×™ - Locrian</option>

            <option value="major_pentatonic" {% if song.key_type == 'major_pentatonic' %}selected{% endif %}>×¤× ×˜×˜×•× ×™ ××–'×•×¨×™ - Major Pentatonic</option>
            <option value="minor_pentatonic" {% if song.key_type == 'minor_pentatonic' %}selected{% endif %}>×¤× ×˜×˜×•× ×™ ××™× ×•×¨×™ - Minor Pentatonic</option>

            <option value="chromatic" {% if song.key_type == 'chromatic' %}selected{% endif %}>×›×¨×•××˜×™ - Chromatic</option>
            <option value="whole_tone" {% if song.key_type == 'whole_tone' %}selected{% endif %}>×©×œ× ×˜×•× ×™× - Whole Tone</option>
            <option value="blues" {% if song.key_type == 'blues' %}selected{% endif %}>×‘×œ×•×– - Blues</option>
            <option value="octatonic" {% if song.key_type == 'octatonic' %}selected{% endif %}>××•×§×˜×˜×•× ×™ / ×“×™××™× ×™×©×“ - Octatonic / Diminished</option>
        </select>

        <label for="difficulty">×¨××ª ×§×•×©×™:</label>
        <select id="difficulty" name="difficulty" required>
            <option value="">×‘×—×¨ ×¨××ª ×§×•×©×™</option>
            <option value="beginner" {% if song.difficulty == 'beginner' %}selected{% endif %}>××ª×—×™×œ×™×</option>
            <option value="intermediate" {% if song.difficulty == 'intermediate' %}selected{% endif %}>×‘×™× ×™×™×</option>
            <option value="advanced" {% if song.difficulty == 'advanced' %}selected{% endif %}>××ª×§×“××™×</option>
        </select>

        <label for="time_signature">××§×¦×‘:</label>
        <select id="time_signature" name="time_signature" required>
            <option value="">×‘×—×¨ ××§×¦×‘</option>
            <option value="4/4" {% if song.time_signature == '4/4' %}selected{% endif %}>4/4 (×”× ×¤×•×¥ ×‘×™×•×ª×¨)</option>
            <option value="2/4" {% if song.time_signature == '2/4' %}selected{% endif %}>2/4</option>
            <option value="3/4" {% if song.time_signature == '3/4' %}selected{% endif %}>3/4 (×•×œ×¡)</option>
            <option value="2/2" {% if song.time_signature == '2/2' %}selected{% endif %}>2/2 (Alla Breve)</option>
            <option value="3/2" {% if song.time_signature == '3/2' %}selected{% endif %}>3/2</option>
            <option value="3/8" {% if song.time_signature == '3/8' %}selected{% endif %}>3/8</option>

            <option value="6/8" {% if song.time_signature == '6/8' %}selected{% endif %}>6/8 (×‘×œ×•×–/×©×™×¨×™× ×§×¦×‘×™×™×)</option>
            <option value="9/8" {% if song.time_signature == '9/8' %}selected{% endif %}>9/8</option>
            <option value="12/8" {% if song.time_signature == '12/8' %}selected{% endif %}>12/8 (×‘×œ×•×–/×’×•×¡×¤×œ)</option>
            <option value="6/4" {% if song.time_signature == '6/4' %}selected{% endif %}>6/4</option>
            <option value="9/4" {% if song.time_signature == '9/4' %}selected{% endif %}>9/4</option>
            <option value="12/4" {% if song.time_signature == '12/4' %}selected{% endif %}>12/4</option>

            <option value="5/4" {% if song.time_signature == '5/4' %}selected{% endif %}>5/4 (×œ× ×©×’×¨×ª×™)</option>
            <option value="5/8" {% if song.time_signature == '5/8' %}selected{% endif %}>5/8</option>
            <option value="7/4" {% if song.time_signature == '7/4' %}selected{% endif %}>7/4</option>
            <option value="7/8" {% if song.time_signature == '7/8' %}selected{% endif %}>7/8 (××ª×§×“×/××ª× ×™)</option>
            <option value="11/4" {% if song.time_signature == '11/4' %}selected{% endif %}>11/4</option>
            <option value="11/8" {% if song.time_signature == '11/8' %}selected{% endif %}>11/8</option>
            <option value="13/4" {% if song.time_signature == '13/4' %}selected{% endif %}>13/4</option>
            <option value="13/8" {% if song.time_signature == '13/8' %}selected{% endif %}>13/8</option>
        </select>

        <label for="bpm">BPM (××”×™×¨×•×ª):</label>
        <input type="number" id="bpm" name="bpm" value="{{ song.bpm }}" required min="40" max="200" step="1">
        <span style="font-size:0.95em;color:gray;">(40-200)</span>

        <label for="video_url">ğŸ¥ ×§×™×©×•×¨ ×œ×¡×¨×˜×•×Ÿ:</label>
        <input type="text" id="video_url" name="video_url" value="{{ song.video_url }}" required>

        <label>ğŸ¸ ××§×•×¨×“×™×:</label>
        <!-- ×”×•×“×¢×ª ×”×¦×œ×—×” ×ª×•×¦×’ ×›××Ÿ, ×•××™×“ ××—×¨×™ ×–×” ×”×›×¤×ª×•×¨ -->
        <div id="chords-success" style="display:none; margin: 6px 0 10px 0;">
            <span style="color:green; font-weight:bold;">ğŸ¶ ×”××§×•×¨×“×™× × ×•×¡×¤×• ×‘×”×¦×œ×—×”!</span>
        </div>
        <button type="button" class="btn" id="chords-btn" onclick="goToChordsPage()">×¢×¨×•×š ××§×•×¨×“×™×</button>
        <input type="hidden" id="chords" name="chords" required>
        <!-- ×”×•×¡×¤×ª ×©×“×” × ×¡×ª×¨ ×œ×œ×•×¤×™× -->
        <input type="hidden" id="loops" name="loops">

        <button type="submit" class="btn">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
    </form>

    <p id="response-message" class="message"></p>
</div>

<script>
    const songId = "{{ song.id }}";

    // Parse existing chords and loops from server-side data
    let existingChords = [];
    let existingLoops = [];

    try {
        existingChords = {{ song.chords|safe }};
        console.log("Loaded existing chords:", existingChords);
    } catch (e) {
        console.error("Error parsing existing chords:", e);
        existingChords = [];
    }

    try {
        const loopsData = "{{ song.loops|default('[]')|safe }}";
        if (loopsData && loopsData !== '[]') {
            existingLoops = JSON.parse(loopsData);
            console.log("Loaded existing loops:", existingLoops);
        }
    } catch (e) {
        console.error("Error parsing existing loops:", e);
        existingLoops = [];
    }

    // Clear any conflicting localStorage data when entering edit mode
    function clearConflictingData() {
        localStorage.removeItem("addingNewSong");
        localStorage.removeItem("songData");
        console.log("Cleared conflicting localStorage data for song editing");
    }

    // Button navigation - ×¢×¨×™×›×ª ×©×™×¨ ×§×™×™×
    function goToChordsPage() {
        // Clear conflicting data
        clearConflictingData();

        // Save current form data before going to chords page
        saveFormData();

        // Store existing chords and loops for editing
        try {
            localStorage.setItem("chords", JSON.stringify(existingChords));
            localStorage.setItem("loops", JSON.stringify(existingLoops));
            localStorage.setItem("editingSongId", songId);
            console.log("Stored data for editing - chords:", existingChords, "loops:", existingLoops);
        } catch (e) {
            console.error("Error storing data for editing:", e);
        }

        window.location.href = "/add-chords";
    }

    // Edit chords for existing song
    function editChords() {
        clearConflictingData();
        saveFormData();

        try {
            localStorage.setItem("chords", JSON.stringify(existingChords));
            localStorage.setItem("loops", JSON.stringify(existingLoops));
            localStorage.setItem("editingSongId", songId);
            console.log("Stored updated data for editing");
        } catch (e) {
            console.error("Error storing updated data for editing:", e);
        }

        window.location.href = "/add-chords";
    }

    function saveFormData() {
        const formData = {
            title: document.getElementById("title").value,
            artist: document.getElementById("artist").value,
            key: document.getElementById("key").value,
            key_type: document.getElementById("key_type").value,
            difficulty: document.getElementById("difficulty").value,
            time_signature: document.getElementById("time_signature").value,
            bpm: document.getElementById("bpm").value,
            video_url: document.getElementById("video_url").value
        };
        localStorage.setItem("editSongData", JSON.stringify(formData));
    }

    // --- Prefill form from localStorage if exists ---
    document.addEventListener("DOMContentLoaded", function () {
        // Clear conflicting data on page load
        clearConflictingData();

        // Load existing chords and loops into hidden fields
        document.getElementById("chords").value = JSON.stringify(existingChords);
        document.getElementById("loops").value = JSON.stringify(existingLoops);

        // Prefill fields from localStorage if user was editing
        const editSongData = JSON.parse(localStorage.getItem("editSongData") || "{}");
        for (const key in editSongData) {
            const element = document.getElementById(key);
            if (element && editSongData[key]) {
                element.value = editSongData[key];
            }
        }

        // Check if user just returned from chords page
        const chordsSuccessDiv = document.getElementById("chords-success");
        const chordsBtn = document.getElementById("chords-btn");
        const savedChords = localStorage.getItem("chords");
        const savedLoops = localStorage.getItem("loops");
        const justReturnedFromChords = localStorage.getItem("justReturnedFromChords");
        const editingSongId = localStorage.getItem("editingSongId");

        if (savedChords && justReturnedFromChords === "true" && editingSongId === songId) {
            // User just returned from chords page - show success message
            try {
                const parsedChords = JSON.parse(savedChords);
                const parsedLoops = savedLoops ? JSON.parse(savedLoops) : [];

                document.getElementById("chords").value = savedChords;
                document.getElementById("loops").value = savedLoops || "[]";

                existingChords = parsedChords; // Update the existing chords
                existingLoops = parsedLoops; // Update the existing loops

                chordsSuccessDiv.style.display = "block";
                chordsBtn.textContent = "×¢×¨×•×š ××§×•×¨×“×™×";
                chordsBtn.onclick = editChords;
                // Clear the flag so it won't show again on refresh
                localStorage.removeItem("justReturnedFromChords");

                console.log("Successfully updated chords and loops from localStorage");
            } catch (e) {
                console.error("Error parsing returned chords/loops:", e);
            }
        } else {
            // Show regular edit chords button
            chordsSuccessDiv.style.display = "none";
            chordsBtn.textContent = "×¢×¨×•×š ××§×•×¨×“×™×";
            chordsBtn.onclick = editChords;
        }

        // Save form fields to localStorage on change
        const fields = ["title", "artist", "key", "key_type", "difficulty", "time_signature", "bpm", "video_url"];
        fields.forEach(field => {
            const el = document.getElementById(field);
            if (el) {
                el.addEventListener("input", () => {
                    const currentData = JSON.parse(localStorage.getItem("editSongData") || "{}");
                    currentData[field] = el.value;
                    localStorage.setItem("editSongData", JSON.stringify(currentData));
                });
            }
        });
    });

    document.getElementById("edit-song-form").addEventListener("submit", function (event) {
        event.preventDefault();

        const title = document.getElementById("title").value;
        const artist = document.getElementById("artist").value;
        const key = document.getElementById("key").value;
        const keyType = document.getElementById("key_type").value;
        const difficulty = document.getElementById("difficulty").value;
        const timeSignature = document.getElementById("time_signature").value;
        const bpm = document.getElementById("bpm").value;
        const videoUrl = document.getElementById("video_url").value;
        const chordsRaw = document.getElementById("chords").value;
        const loopsRaw = document.getElementById("loops").value; // ×”×•×¡×¤×” ×—×“×©×”

        let finalVideoUrl = videoUrl;
        const ytMatch = videoUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([A-Za-z0-9_\-]+)/);
        if (ytMatch && ytMatch[1]) {
            finalVideoUrl = "https://www.youtube.com/embed/" + ytMatch[1];
        }

        let chords, loops = [];
        try {
            chords = JSON.parse(chordsRaw);
        } catch (e) {
            alert("×©×’×™××” ×‘×§×¨×™××ª ×”××§×•×¨×“×™×. × ×¡×” ×©×•×‘ ×œ×”×•×¡×™×£ ××•×ª×.");
            return;
        }

        // ×”×•×¡×¤×” ×—×“×©×” - ×§×¨×™××ª × ×ª×•× ×™ ×”×œ×•×¤×™×
        if (loopsRaw) {
            try {
                loops = JSON.parse(loopsRaw);
            } catch (e) {
                console.log("Error parsing loops data:", e);
                loops = [];
            }
        }

        fetch(`/api/edit_song/${songId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                title: title,
                artist: artist,
                key: key,
                key_type: keyType,
                difficulty: difficulty,
                time_signature: timeSignature,
                bpm: parseInt(bpm),
                video_url: finalVideoUrl,
                chords: chords,
                loops: loops // ×”×•×¡×¤×” ×—×“×©×” - ×©×œ×™×—×ª × ×ª×•× ×™ ×”×œ×•×¤×™×
            })
        })
        .then(response => response.json())
        .then(data => {
            const messageEl = document.getElementById("response-message");
            if (data.message) {
                messageEl.textContent = "âœ… " + data.message;
                messageEl.style.color = "green";
                // Clear localStorage after successful edit
                localStorage.removeItem("editSongData");
                localStorage.removeItem("justReturnedFromChords");
                localStorage.removeItem("editingSongId");
                localStorage.removeItem("chords");
                localStorage.removeItem("loops");
                // Redirect to song page after short delay - ×¢×“×›×•×Ÿ ×œ×”×¤× ×™×™×” ×œ×¢××•×“ ×”× ×’×Ÿ
                setTimeout(() => {
                    window.location.href = `/play/${songId}`;
                }, 1500);
            } else {
                messageEl.textContent = "âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×©×™×¨, × ×¡×” ×©×•×‘";
                messageEl.style.color = "red";
            }
        })
        .catch(error => {
            document.getElementById("response-message").textContent = "âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×©×™×¨!";
            document.getElementById("response-message").style.color = "red";
            console.error("Error:", error);
        });
    });
</script>

<style>
    .styled-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
        margin: auto;
    }

    .styled-form label {
        font-weight: bold;
        text-align: right;
    }

    .styled-form input,
    .styled-form select {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .btn {
        background-color: #28a745;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .btn:hover {
        background-color: #218838;
    }

    .message {
        text-align: center;
        font-weight: bold;
        margin-top: 10px;
    }
</style>
{% endblock %}
