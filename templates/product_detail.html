{% extends "base.html" %}

{% block title %}{{ product_name }} - מוצר למוזיקאים{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/product_detail.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/products.css') }}">
{% endblock %}

{% block content %}
<div class="product-detail-container">
    <div id="loadingState" class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>טוען פרטי מוצר...</p>
    </div>

    <div id="errorState" class="error-state" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <p>שגיאה בטעינת המוצר</p>
        <a href="/products" class="back-btn">חזור לעמוד המוצרים</a>
    </div>

    <div id="productContent" style="display: none;">
        <!-- Product Header -->
        <div class="product-header">
            <a href="/products" class="back-link">
                <i class="fas fa-arrow-right"></i> חזור לעמוד המוצרים
            </a>
            <h1 id="productName"></h1>
            <div class="product-header-meta">
                <span id="productCategory" class="category-badge"></span>
                <span id="productRating" class="rating-display"></span>
            </div>
        </div>

        <!-- Main Product Section -->
        <div class="product-main-section">
            <!-- Left: Images Gallery -->
            <div class="product-images-section">
                <div class="main-image-container">
                    <img id="mainProductImage" src="" alt="" class="main-product-image">
                </div>
                <div id="imageGallery" class="image-gallery">
                    <!-- Thumbnail images will be loaded here -->
                </div>
                <div id="videoSection" class="video-section" style="display: none;">
                    <h3>סרטונים</h3>
                    <div id="productVideos" class="videos-grid">
                        <!-- Videos will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Right: Product Info & Actions -->
            <div class="product-info-section">
                <div class="price-section">
                    <div class="price-main">
                        <span id="productPriceILS" class="price-ils"></span>
                        <span id="productPriceUSD" class="price-usd"></span>
                    </div>
                    <div id="shippingInfo" class="shipping-info"></div>
                </div>

                <div class="product-description-section">
                    <h3>תיאור המוצר</h3>
                    <p id="productDescription" class="product-description-text"></p>
                </div>

                <div class="website-info">
                    <p><strong>נמכר ב:</strong> <span id="productWebsite"></span></p>
                </div>

                <div class="product-actions-section">
                    <a id="buyButton" href="#" target="_blank" class="buy-button">
                        <i class="fas fa-shopping-cart"></i>
                        קנה עכשיו
                    </a>
                    <button onclick="shareProduct()" class="share-button">
                        <i class="fas fa-share-alt"></i>
                        שתף
                    </button>
                </div>

                {% if session.get('roles') and 'admin' in session.get('roles') %}
                <div class="admin-actions">
                    <button onclick="editProductFromDetail()" class="admin-btn edit-btn">
                        <i class="fas fa-edit"></i> ערוך מוצר
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="reviews-section">
            <div class="reviews-header">
                <h2>תגובות משתמשים</h2>
                <div class="average-rating">
                    <span id="averageRating"></span>
                    <span id="reviewsCount"></span>
                </div>
            </div>

            {% if session.get('user_id') %}
            <div class="add-review-form">
                <h3>הוסף תגובה</h3>
                <div class="review-form-content">
                    <div class="review-rating-input">
                        <label>דירוג:</label>
                        <div class="star-rating" id="reviewStarRating">
                            <i class="far fa-star" data-rating="1"></i>
                            <i class="far fa-star" data-rating="2"></i>
                            <i class="far fa-star" data-rating="3"></i>
                            <i class="far fa-star" data-rating="4"></i>
                            <i class="far fa-star" data-rating="5"></i>
                        </div>
                        <span id="selectedRatingText">0</span>
                    </div>
                    <textarea id="reviewComment" placeholder="כתוב את התגובה שלך כאן..." rows="4"></textarea>
                    <input type="url" id="reviewVideoUrl" placeholder="קישור לסרטון ביקורת (אופציונלי)">
                    <button onclick="submitReview()" class="submit-review-btn">שלח תגובה</button>
                </div>
            </div>
            {% else %}
            <div class="login-prompt">
                <p>כדי להוסיף תגובה, אנא <a href="/login">התחבר</a></p>
            </div>
            {% endif %}

            <div id="reviewsList" class="reviews-list">
                <!-- Reviews will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal (Admin Only) -->
{% if session.get('roles') and 'admin' in session.get('roles') %}
<div id="addProductModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddProductModal()">&times;</span>
        <h2>ערוך מוצר</h2>
        <form id="addProductForm" onsubmit="addProduct(event)">
            <div class="form-group">
                <label for="productName">שם המוצר</label>
                <input type="text" id="productName" required>
            </div>

            <div class="form-group">
                <label for="productDescription">תיאור</label>
                <textarea id="productDescription" rows="4" required></textarea>
            </div>

            <div class="form-group">
                <label for="productImage">תמונה (URL)</label>
                <input type="url" id="productImage" required>
            </div>

            <div class="form-group">
                <label for="productAliexpressLink">קישור לאלי אקספרס</label>
                <input type="url" id="productAliexpressLink" required>
            </div>

            <div class="form-group">
                <label for="productMainCategory">קטגוריה ראשית</label>
                <select id="productMainCategory" required>
                    <option value="תופים">תופים</option>
                    <option value="קלידים">קלידים</option>
                    <option value="גיטרות">גיטרות</option>
                    <option value="כלי נשיפה">כלי נשיפה</option>
                    <option value="ציוד אודיו">ציוד אודיו</option>
                    <option value="אביזרים">אביזרים</option>
                </select>
            </div>

            <div class="form-group">
                <label for="productSubCategory">תת-קטגוריה (אופציונלי)</label>
                <input type="text" id="productSubCategory" placeholder="למשל: מקלות תופים, מיתרים לגיטרה">
            </div>

            <div class="form-group">
                <label for="productWebsiteName">שם האתר</label>
                <input type="text" id="productWebsiteName" value="AliExpress" placeholder="AliExpress, eBay וכו'">
            </div>

            <div class="form-group">
                <label for="productRating">דירוג משוער (1-5) - אופציונלי</label>
                <input type="number" id="productRating" min="1" max="5" step="0.1">
            </div>

            <div class="form-group">
                <label>מחיר</label>
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <input type="number" id="productPriceILS" step="0.01" min="0" placeholder="מחיר בשקלים">
                    </div>
                    <div style="flex: 1;">
                        <input type="number" id="productPriceUSD" step="0.01" min="0" placeholder="או מחיר בדולרים">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="productShippingType">שילוח</label>
                <select id="productShippingType" onchange="updateShippingFields()">
                    <option value="free">חינם</option>
                    <option value="paid">בתשלום</option>
                    <option value="free_above_amount">חינם מעל סכום מסוים</option>
                </select>
            </div>

            <div class="form-group" id="shippingCostGroup" style="display: none;">
                <label for="productShippingCost">עלות שילוח (שקלים)</label>
                <input type="number" id="productShippingCost" step="0.01" min="0">
            </div>

            <div class="form-group" id="freeShippingAboveGroup" style="display: none;">
                <label for="productFreeShippingAbove">חינם מעל (שקלים)</label>
                <input type="number" id="productFreeShippingAbove" step="0.01" min="0">
            </div>

            <div class="form-group">
                <label for="productImages">תמונות נוספות (URLs, מופרדות בפסיק)</label>
                <textarea id="productImages" rows="3" placeholder="https://example.com/img1.jpg, https://example.com/img2.jpg"></textarea>
            </div>

            <div class="form-group">
                <label for="productVideos">סרטונים (URLs, מופרדות בפסיק)</label>
                <textarea id="productVideos" rows="3" placeholder="https://youtube.com/watch?v=..., https://youtube.com/watch?v=..."></textarea>
            </div>

            <button type="submit" class="submit-btn">עדכן מוצר</button>
        </form>
    </div>
</div>
{% endif %}

<script>
    // Pass data to JavaScript
    window.productId = '{{ product_id }}';
    window.userId = {{ session.get('user_id') | tojson or 'null' }};
    window.userRoles = {{ session.get('roles', []) | tojson }};
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/product_detail.js') }}"></script>
{% endblock %}

