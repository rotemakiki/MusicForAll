{% extends "base.html" %}

{% block title %}×¨×©×™××ª ×©×™×¨×™×{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/songs.css') }}">
<style>
/* Additional styles for multiple genres display */
.genres-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.genre-tag {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-block;
    white-space: nowrap;
}

.genre-tag:only-child {
    /* If there's only one genre, make it slightly larger */
    padding: 3px 10px;
    font-size: 0.8rem;
}

/* Song version badge in list */
.song-version-badge {
    display: inline-block;
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 10px;
    margin-top: 4px;
    font-weight: 600;
}
.song-version-badge.version-cover {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    color: white;
}
.song-version-badge.version-original {
    background: linear-gradient(135deg, #4facfe, #00f2fe);
    color: white;
}
.song-version-badge.version-live {
    background: linear-gradient(135deg, #43e97b, #38f9d7);
    color: #1a1a1a;
}
.song-version-cover-hint {
    font-size: 0.85em;
    color: #888;
    font-weight: normal;
}

@media (max-width: 768px) {
    .genres-container {
        gap: 2px;
    }

    .genre-tag {
        font-size: 0.7rem;
        padding: 2px 6px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="songs-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">ğŸµ ×¨×©×™××ª ×©×™×¨×™×</h1>
        <p class="page-subtitle">×’×œ×” ××ª ×”×©×™×¨×™× ×”××™×•×—×“×™× ×©×œ× ×• ×•×ª×ª×—×™×œ ×œ× ×’×Ÿ</p>

        <div class="songs-count">
            <span class="count-number">{{ songs|length }}</span>
            <span class="count-label">×©×™×¨×™× ×–××™× ×™×</span>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            {% set roles = session.get('roles', []) %}
            {% if 'teacher' in roles or 'musician' in roles or 'admin' in roles %}
                <a href="{{ url_for('songs.add_song_page') }}" class="add-song-btn">
                    <span>â•</span>
                    <span>×”×•×¡×£ ×©×™×¨ ×—×“×©</span>
                </a>
            {% endif %}
            {% if session.get('user_id') %}
                <a href="{{ url_for('my_songs.my_songs_page') }}" class="my-songs-link-btn">
                    <span>â¤ï¸</span>
                    <span>×”×©×™×¨×™× ×©×œ×™</span>
                </a>
            {% else %}
                <a href="{{ url_for('auth.login') }}" class="my-songs-link-btn" title="×”×ª×—×‘×¨ ×›×“×™ ×œ×’×©×ª ×œ×¨×©×™××ª ×”×©×™×¨×™× ×©×œ×š">
                    <span>â¤ï¸</span>
                    <span>×”×©×™×¨×™× ×©×œ×™</span>
                </a>
            {% endif %}
        </div>

    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-controls">
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="search-input" placeholder="×—×¤×© ×©×™×¨ ××• ×××Ÿ...">
            </div>

            <select id="sort-select" class="sort-dropdown">
                <option value="alphabetical">××œ×¤×‘×™×ª×™ (×©× ×©×™×¨)</option>
                <option value="recent" selected>×”×•×¢×œ×” ×œ××—×¨×•× ×”</option>
                <option value="rating">×“×™×¨×•×’ ××©×ª××©×™×</option>
                <option value="watched">×©×™×¨×™× ×©×¦×¤×™×ª×™ ×‘×”×</option>
                <option value="my_list">×©×™×¨×™× ××¨×©×™××ª ×”×©×™×¨×™× ×©×œ×™</option>
                <option value="personalized">×‘×”×ª×××” ××™×©×™×ª</option>
                <option value="title">××™×•×Ÿ ×œ×¤×™ ×©× ×”×©×™×¨</option>
                <option value="artist">××™×•×Ÿ ×œ×¤×™ ×××Ÿ</option>
                <option value="difficulty">××™×•×Ÿ ×œ×¤×™ ×¨××ª ×§×•×©×™</option>
                <option value="bpm">××™×•×Ÿ ×œ×¤×™ BPM</option>
                <option value="genres">××™×•×Ÿ ×œ×¤×™ ×–'×× ×¨×™×</option>
            </select>
        </div>
    </div>

    <!-- Songs List -->
    {% if songs %}
        <div class="songs-list">
            {% for song in songs %}
                <div class="song-row" id="song-{{ song.id }}"
                     data-difficulty="{{ song.difficulty }}"
                     data-bpm="{{ song.bpm }}"
                     data-key="{{ song.key }}"
                     data-time-signature="{{ song.time_signature }}"
                     data-genres="{{ song.display_genres | join(',') }}"
                     data-created-at="{{ song.created_at_iso }}"
                     data-in-my-list="{{ 'true' if song.in_my_list else 'false' }}"
                     data-watched="{{ 'true' if song.watched else 'false' }}"
                     data-avg-rating="{{ song.avg_rating }}"
                     data-song-version="{{ song.get('song_version', '') }}">

                    <div class="song-row-content">
                        <div class="song-main-info">
                            <div class="song-title-artist">
                                <h3 class="song-title">{{ song.title }}</h3>
                                <p class="song-artist">{{ song.artist }}
                                    {% if song.get('song_version') == 'cover' and song.get('original_artist') %}
                                        <span class="song-version-cover-hint">(×§××‘×¨ ×©×œ {{ song.original_artist }})</span>
                                    {% endif %}
                                </p>
                                {% if song.get('song_version') %}
                                <span class="song-version-badge version-{{ song.song_version }}" title="×’×¨×¡×ª ×”×©×™×¨">
                                    {% if song.song_version == 'cover' %}×§××‘×¨
                                    {% elif song.song_version == 'original' %}×’×¨×¡×ª ××œ×‘×•×
                                    {% elif song.song_version == 'live' %}×”×•×¤×¢×” ×—×™×”
                                    {% else %}{{ song.song_version }}{% endif %}
                                </span>
                                {% endif %}
                            </div>
                            
                            <div class="song-meta-info">
                                <div class="song-details-row">
                                    <span class="detail-badge">
                                        ğŸ¼ {{ song.key }} {{ song.key_type }}{% if song.get('secondary_key') and song.get('secondary_key_type') %} / {{ song.secondary_key }} {{ song.secondary_key_type }}{% endif %}
                                    </span>
                                    <span class="detail-badge">
                                        ğŸµ {{ song.time_signature }}
                                    </span>
                                    <span class="detail-badge">
                                        âš¡ {{ song.bpm }} BPM
                                    </span>
                                    {% if song.difficulty %}
                                    <span class="detail-badge difficulty-{{ song.difficulty }}">
                                        â­ {{ song.difficulty }}
                                    </span>
                                    {% endif %}
                                </div>
                                
                                <div class="genres-container">
                                    {% if song.display_genres and song.display_genres|length > 0 %}
                                        {% for genre in song.display_genres %}
                                            <span class="genre-tag">{{ genre }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="genre-tag">×œ× ×¦×•×™×Ÿ</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="song-actions-row">
                            <a href="{{ url_for('songs.play_song', song_id=song.id) }}" class="action-btn play-btn">
                                <span>ğŸµ</span>
                                <span>×œ×¢××•×“ ×”×©×™×¨</span>
                            </a>

                            {% if session.get('user_id') %}
                                <button class="action-btn my-songs-btn"
                                        data-song-id="{{ song.id }}"
                                        onclick="toggleMySong('{{ song.id }}', this)">
                                    <span class="icon">â¤ï¸</span>
                                    <span class="text">×”×•×¡×£ ×œ×©×™×¨×™× ×©×œ×™</span>
                                </button>
                            {% else %}
                                <a href="{{ url_for('auth.login') }}" class="action-btn my-songs-btn guest-add-my-songs" title="×”×ª×—×‘×¨ ×¢× ××©×ª××© ×¨×©×•× ×›×“×™ ×œ×”×•×¡×™×£ ×©×™×¨×™× ×œ×¨×©×™××” ×©×œ×š">
                                    <span class="icon">â¤ï¸</span>
                                    <span class="text">×”×•×¡×£ ×œ×©×™×¨×™× ×©×œ×™</span>
                                </a>
                            {% endif %}

                            {% if session.get('user_id') == song.created_by or 'admin' in (session.get('roles') or []) %}
                                <a href="{{ url_for('songs.edit_song', song_id=song.id) }}" class="action-btn edit-btn">
                                    <span>âœï¸</span>
                                    <span>×¢×¨×•×š</span>
                                </a>

                                <button class="action-btn delete-btn"
                                        onclick="deleteSong('{{ song.id }}', '{{ song.title }}')">
                                    <span>ğŸ—‘ï¸</span>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸµ</div>
            <h3>××™×Ÿ ×©×™×¨×™× ×–××™× ×™×</h3>
            <p>×¢×“×™×™×Ÿ ×œ× × ×•×¡×¤×• ×©×™×¨×™× ×œ××¢×¨×›×ª</p>
            {% set roles = session.get('roles', []) %}
            {% if 'teacher' in roles or 'musician' in roles or 'admin' in roles %}
                <a href="{{ url_for('songs.add_song_page') }}" class="browse-btn">
                    <span>â•</span>
                    <span>×”×•×¡×£ ×©×™×¨ ×¨××©×•×Ÿ</span>
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
// Note: Search, sort, and song management functionality is handled by songs.js
// These functions are kept for backward compatibility but are also defined in songs.js
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/songs.js') }}"></script>
{% endblock %}
