{% extends "base.html" %}

{% block title %}×¨×©×™××ª ×©×™×¨×™×{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/songs.css') }}">
<style>
/* Additional styles for multiple genres display */
.genres-container {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 5px;
}

.genre-tag {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-block;
    white-space: nowrap;
}

.genre-tag:only-child {
    /* If there's only one genre, make it slightly larger */
    padding: 3px 10px;
    font-size: 0.8rem;
}

@media (max-width: 768px) {
    .genres-container {
        gap: 2px;
    }

    .genre-tag {
        font-size: 0.7rem;
        padding: 2px 6px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="songs-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">ğŸµ ×¨×©×™××ª ×©×™×¨×™×</h1>
        <p class="page-subtitle">×’×œ×” ××ª ×”×©×™×¨×™× ×”××™×•×—×“×™× ×©×œ× ×• ×•×ª×ª×—×™×œ ×œ× ×’×Ÿ</p>

        <div class="songs-count">
            <span class="count-number">{{ songs|length }}</span>
            <span class="count-label">×©×™×¨×™× ×–××™× ×™×</span>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            {% set roles = session.get('roles', []) %}
            {% if 'teacher' in roles or 'admin' in roles %}
                <a href="{{ url_for('songs.add_song_page') }}" class="add-song-btn">
                    <span>â•</span>
                    <span>×”×•×¡×£ ×©×™×¨ ×—×“×©</span>
                </a>
            {% endif %}
            {% if session.get('user_id') %}
                <a href="{{ url_for('my_songs.my_songs_page') }}" class="my-songs-link-btn">
                    <span>â¤ï¸</span>
                    <span>×”×©×™×¨×™× ×©×œ×™</span>
                </a>
            {% endif %}
        </div>

    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-controls">
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="search-input" placeholder="×—×¤×© ×©×™×¨ ××• ×××Ÿ...">
            </div>

            <select id="sort-select" class="sort-dropdown">
                <option value="title">××™×•×Ÿ ×œ×¤×™ ×©× ×”×©×™×¨</option>
                <option value="artist">××™×•×Ÿ ×œ×¤×™ ×××Ÿ</option>
                <option value="difficulty">××™×•×Ÿ ×œ×¤×™ ×¨××ª ×§×•×©×™</option>
                <option value="bpm">××™×•×Ÿ ×œ×¤×™ BPM</option>
                <option value="genres">××™×•×Ÿ ×œ×¤×™ ×–'×× ×¨×™×</option>
            </select>
        </div>
    </div>

    <!-- Songs Grid -->
    {% if songs %}
        <div class="songs-grid">
            {% for song in songs %}
                <div class="song-card" id="song-{{ song.id }}"
                     data-difficulty="{{ song.difficulty }}"
                     data-bpm="{{ song.bpm }}"
                     data-key="{{ song.key }}"
                     data-time-signature="{{ song.time_signature }}"
                     data-genres="{{ song.display_genres | join(',') }}">

                    <div class="song-header">
                        <div class="song-info">
                            <h3>{{ song.title }}</h3>
                            <p>{{ song.artist }}</p>
                        </div>
                    </div>

                    <div class="song-details">
                        <span class="detail-badge">
                            ğŸ¼ {{ song.key }} {{ song.key_type }}
                        </span>
                        <span class="detail-badge">
                            ğŸµ {{ song.time_signature }}
                        </span>
                        <span class="detail-badge">
                            âš¡ {{ song.bpm }} BPM
                        </span>
                        {% if song.difficulty %}
                        <span class="detail-badge difficulty-{{ song.difficulty }}">
                            â­ {{ song.difficulty }}
                        </span>
                        {% endif %}
                    </div>

                    <!-- Genres Display -->
                    <div class="genres-container">
                        {% if song.display_genres and song.display_genres|length > 0 %}
                            {% for genre in song.display_genres %}
                                <span class="genre-tag">{{ genre }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="genre-tag">×œ× ×¦×•×™×Ÿ</span>
                        {% endif %}
                    </div>

                    <div class="song-actions">
                        <a href="{{ url_for('songs.play_song', song_id=song.id) }}" class="action-btn play-btn">
                            <span>ğŸµ</span>
                            <span>×œ×¢××•×“ ×”×©×™×¨</span>
                        </a>

                        {% if session.get('user_id') %}
                            <button class="action-btn my-songs-btn"
                                    data-song-id="{{ song.id }}"
                                    onclick="toggleMySong('{{ song.id }}', this)">
                                <span class="icon">â¤ï¸</span>
                                <span class="text">×”×•×¡×£ ×œ×©×™×¨×™× ×©×œ×™</span>
                            </button>
                        {% endif %}

                        {% if session.get('user_id') == song.created_by %}
                            <a href="{{ url_for('songs.edit_song', song_id=song.id) }}" class="action-btn edit-btn">
                                <span>âœï¸</span>
                                <span>×¢×¨×•×š</span>
                            </a>

                            <button class="action-btn delete-btn"
                                    onclick="deleteSong('{{ song.id }}', '{{ song.title }}')">
                                <span>ğŸ—‘ï¸</span>
                            </button>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸµ</div>
            <h3>××™×Ÿ ×©×™×¨×™× ×–××™× ×™×</h3>
            <p>×¢×“×™×™×Ÿ ×œ× × ×•×¡×¤×• ×©×™×¨×™× ×œ××¢×¨×›×ª</p>
            {% set roles = session.get('roles', []) %}
            {% if 'teacher' in roles or 'admin' in roles %}
                <a href="{{ url_for('songs.add_song_page') }}" class="browse-btn">
                    <span>â•</span>
                    <span>×”×•×¡×£ ×©×™×¨ ×¨××©×•×Ÿ</span>
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
// Enhanced search and filter functionality for multiple genres
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    const songCards = document.querySelectorAll('.song-card');

    // Search functionality
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();

            songCards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                const artist = card.querySelector('p').textContent.toLowerCase();
                const genres = card.getAttribute('data-genres').toLowerCase();

                const isVisible = title.includes(searchTerm) ||
                                artist.includes(searchTerm) ||
                                genres.includes(searchTerm);

                card.style.display = isVisible ? 'block' : 'none';
            });
        });
    }

    // Sort functionality
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            const sortBy = this.value;
            const songsGrid = document.querySelector('.songs-grid');
            const cards = Array.from(songCards);

            cards.sort((a, b) => {
                let aValue, bValue;

                switch(sortBy) {
                    case 'title':
                        aValue = a.querySelector('h3').textContent;
                        bValue = b.querySelector('h3').textContent;
                        break;
                    case 'artist':
                        aValue = a.querySelector('p').textContent;
                        bValue = b.querySelector('p').textContent;
                        break;
                    case 'difficulty':
                        const difficultyOrder = { 'beginner': 1, 'intermediate': 2, 'advanced': 3 };
                        aValue = difficultyOrder[a.getAttribute('data-difficulty')] || 0;
                        bValue = difficultyOrder[b.getAttribute('data-difficulty')] || 0;
                        return aValue - bValue;
                    case 'bpm':
                        aValue = parseInt(a.getAttribute('data-bpm'));
                        bValue = parseInt(b.getAttribute('data-bpm'));
                        return aValue - bValue;
                    case 'genres':
                        aValue = a.getAttribute('data-genres').split(',')[0] || '';
                        bValue = b.getAttribute('data-genres').split(',')[0] || '';
                        break;
                    default:
                        return 0;
                }

                if (sortBy !== 'difficulty' && sortBy !== 'bpm') {
                    return aValue.localeCompare(bValue, 'he');
                }
            });

            // Re-append sorted cards
            cards.forEach(card => songsGrid.appendChild(card));
        });
    }
});

// Function to toggle song in user's collection
function toggleMySong(songId, button) {
    // This function should be implemented based on your my_songs functionality
    console.log('Toggle my song:', songId);
    // Add your implementation here
}

// Function to delete song
function deleteSong(songId, title) {
    if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×©×™×¨ "${title}"?`)) {
        fetch(`/api/delete_song/${songId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                document.getElementById(`song-${songId}`).remove();
                alert('×”×©×™×¨ × ××—×§ ×‘×”×¦×œ×—×”!');
            } else {
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×©×™×¨: ' + (data.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('×©×’×™××” ×‘××—×™×§×ª ×”×©×™×¨!');
        });
    }
}
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/songs.js') }}"></script>
{% endblock %}
