{% extends "base.html" %}

{% block title %}הוספת שיר{% endblock %}

{% block content %}
<div class="container">
    <h1>🎵 הוספת שיר חדש 🎶</h1>
    <form id="add-song-form" class="styled-form">
        <label for="title">שם השיר:</label>
        <input type="text" id="title" name="title" required>

        <label for="artist">שם האמן:</label>
        <input type="text" id="artist" name="artist" required>

        <label for="key">סולם:</label>
        <select id="key" name="key" required>
            <option value="">בחר סולם</option>
            <option value="C">דו - C</option>
            <option value="C#">דו דיאז - C#</option>
            <option value="Db">רה במול - Db</option>
            <option value="D">רה - D</option>
            <option value="D#">רה דיאז - D#</option>
            <option value="Eb">מי במול - Eb</option>
            <option value="E">מי - E</option>
            <option value="F">פה - F</option>
            <option value="F#">פה דיאז - F#</option>
            <option value="Gb">סול במול - Gb</option>
            <option value="G">סול - G</option>
            <option value="G#">סול דיאז - G#</option>
            <option value="Ab">לה במול - Ab</option>
            <option value="A">לה - A</option>
            <option value="A#">לה דיאז - A#</option>
            <option value="Bb">סי במול - Bb</option>
            <option value="B">סי - B</option>
        </select>

        <label for="key_type">סוג סולם:</label>
        <select id="key_type" name="key_type" required>
            <option value="">בחר סוג</option>
            <option value="major">מז'ור - Major</option>
            <option value="natural_minor">מינור טבעי - Natural Minor</option>
            <option value="harmonic_minor">מינור הרמוני - Harmonic Minor</option>
            <option value="melodic_minor">מינור מלודי - Melodic Minor</option>

            <option value="ionian">יוֹני - Ionian</option>
            <option value="dorian">דוֹרי - Dorian</option>
            <option value="phrygian">פריגי - Phrygian</option>
            <option value="lydian">לידי - Lydian</option>
            <option value="mixolydian">מיקסולידי - Mixolydian</option>
            <option value="aeolian">אאולי - Aeolian</option>
            <option value="locrian">לוֹקרי - Locrian</option>

            <option value="major_pentatonic">פנטטוני מז'ורי - Major Pentatonic</option>
            <option value="minor_pentatonic">פנטטוני מינורי - Minor Pentatonic</option>

            <option value="chromatic">כרומטי - Chromatic</option>
            <option value="whole_tone">שלם טונים - Whole Tone</option>
            <option value="blues">בלוז - Blues</option>
            <option value="octatonic">אוקטטוני / דימינישד - Octatonic / Diminished</option>
        </select>

        <label for="difficulty">רמת קושי:</label>
        <select id="difficulty" name="difficulty" required>
            <option value="">בחר רמת קושי</option>
            <option value="beginner">מתחילים</option>
            <option value="intermediate">ביניים</option>
            <option value="advanced">מתקדמים</option>
        </select>

        <label for="time_signature">מקצב:</label>
        <select id="time_signature" name="time_signature" required>
            <option value="">בחר מקצב</option>
            <option value="4/4">4/4 (הנפוץ ביותר)</option>
            <option value="2/4">2/4</option>
            <option value="3/4">3/4 (ולס)</option>
            <option value="2/2">2/2 (Alla Breve)</option>
            <option value="3/2">3/2</option>
            <option value="3/8">3/8</option>

            <option value="6/8">6/8 (בלוז/שירים קצביים)</option>
            <option value="9/8">9/8</option>
            <option value="12/8">12/8 (בלוז/גוספל)</option>
            <option value="6/4">6/4</option>
            <option value="9/4">9/4</option>
            <option value="12/4">12/4</option>

            <option value="5/4">5/4 (לא שגרתי)</option>
            <option value="5/8">5/8</option>
            <option value="7/4">7/4</option>
            <option value="7/8">7/8 (מתקדם/אתני)</option>
            <option value="11/4">11/4</option>
            <option value="11/8">11/8</option>
            <option value="13/4">13/4</option>
            <option value="13/8">13/8</option>
        </select>

        <label for="bpm">BPM (מהירות):</label>
        <input type="number" id="bpm" name="bpm" required min="40" max="200" step="1" value="100">
        <span style="font-size:0.95em;color:gray;">(40-200)</span>

        <label for="video_url">🎥 קישור לסרטון:</label>
        <input type="text" id="video_url" name="video_url" required>

        <label>🎸 אקורדים:</label>
        <!-- הודעת הצלחה תוצג כאן, ומיד אחרי זה הכפתור -->
        <div id="chords-success" style="display:none; margin: 6px 0 10px 0;">
            <span style="color:green; font-weight:bold;">🎶 האקורדים נוספו בהצלחה!</span>
        </div>
        <button type="button" class="btn" id="chords-btn" onclick="goToChordsPage()">הוסף אקורדים</button>
        <input type="hidden" id="chords" name="chords" required>
        <input type="hidden" id="loops" name="loops">

        <button type="submit" class="btn">➕ הוסף שיר</button>
    </form>

    <p id="response-message" class="message"></p>
</div>

<script>
    // Clear any existing editing data when starting a new song
    function clearEditingData() {
        localStorage.removeItem("editingSongId");
        localStorage.removeItem("editSongData");
        localStorage.removeItem("justReturnedFromChords");
        console.log("Cleared editing data for new song");
    }

    // Button navigation for new song
    function goToChordsPage() {
        // Save current form data before going to chords page
        saveNewSongFormData();
        // Clear any editing flags to ensure we're in "new song" mode
        localStorage.removeItem("editingSongId");
        localStorage.setItem("addingNewSong", "true");
        window.location.href = "/add-chords";
    }

    // Edit chords for new song
    function editNewSongChords() {
        saveNewSongFormData();
        localStorage.setItem("addingNewSong", "true");
        window.location.href = "/add-chords";
    }

    function saveNewSongFormData() {
        const formData = {
            title: document.getElementById("title").value,
            artist: document.getElementById("artist").value,
            key: document.getElementById("key").value,
            key_type: document.getElementById("key_type").value,
            difficulty: document.getElementById("difficulty").value,
            time_signature: document.getElementById("time_signature").value,
            bpm: document.getElementById("bpm").value,
            video_url: document.getElementById("video_url").value
        };
        localStorage.setItem("songData", JSON.stringify(formData));
    }

    // --- Initialize page ---
    document.addEventListener("DOMContentLoaded", function () {
        // Clear editing data when entering new song page
        clearEditingData();

        // Prefill fields from localStorage if exists (for new song in progress)
        const songData = JSON.parse(localStorage.getItem("songData") || "{}");
        for (const key in songData) {
            if (document.getElementById(key)) {
                document.getElementById(key).value = songData[key];
            }
        }

        // Check chords state for new song
        const chordsSuccessDiv = document.getElementById("chords-success");
        const chordsBtn = document.getElementById("chords-btn");
        const savedChords = localStorage.getItem("chords");
        const savedLoops = localStorage.getItem("loops");
        const justReturnedFromChords = localStorage.getItem("justReturnedFromChords");
        const addingNewSong = localStorage.getItem("addingNewSong");

        // Only use saved chords if we're actually adding a new song (not editing existing)
        if (savedChords && justReturnedFromChords === "true" && addingNewSong === "true") {
            // User just returned from chords page for new song - show success message
            document.getElementById("chords").value = savedChords;
            if (savedLoops) {
                document.getElementById("loops").value = savedLoops;
            }
            chordsSuccessDiv.style.display = "block";
            chordsBtn.textContent = "ערוך אקורדים שנוספו";
            chordsBtn.onclick = editNewSongChords;
            // Clear the flag so it won't show again on refresh
            localStorage.removeItem("justReturnedFromChords");
        } else if (savedChords && addingNewSong === "true") {
            // Chords exist for new song but user didn't just return from chords page
            document.getElementById("chords").value = savedChords;
            if (savedLoops) {
                document.getElementById("loops").value = savedLoops;
            }
            chordsSuccessDiv.style.display = "none";
            chordsBtn.textContent = "ערוך אקורדים שנוספו";
            chordsBtn.onclick = editNewSongChords;
        } else {
            // No chords saved for new song - show regular button
            chordsSuccessDiv.style.display = "none";
            chordsBtn.textContent = "הוסף אקורדים";
            chordsBtn.onclick = goToChordsPage;
        }

        // Save form fields to localStorage on change
        const fields = ["title", "artist", "key", "key_type", "difficulty", "time_signature", "bpm", "video_url"];
        fields.forEach(field => {
            const el = document.getElementById(field);
            if (el) {
                el.addEventListener("input", () => {
                    const currentData = JSON.parse(localStorage.getItem("songData") || "{}");
                    currentData[field] = el.value;
                    localStorage.setItem("songData", JSON.stringify(currentData));
                });
            }
        });
    });

    document.getElementById("add-song-form").addEventListener("submit", function (event) {
        event.preventDefault();

        const title = document.getElementById("title").value;
        const artist = document.getElementById("artist").value;
        const key = document.getElementById("key").value;
        const keyType = document.getElementById("key_type").value;
        const difficulty = document.getElementById("difficulty").value;
        const timeSignature = document.getElementById("time_signature").value;
        const bpm = document.getElementById("bpm").value;
        const videoUrl = document.getElementById("video_url").value;
        const chordsRaw = document.getElementById("chords").value;
        const loopsRaw = document.getElementById("loops").value;

        let finalVideoUrl = videoUrl;
        const ytMatch = videoUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([A-Za-z0-9_\-]+)/);
        if (ytMatch && ytMatch[1]) {
            finalVideoUrl = "https://www.youtube.com/embed/" + ytMatch[1];
        }

        let chords, loops = [];
        try {
            chords = JSON.parse(chordsRaw);
        } catch (e) {
            alert("שגיאה בקריאת האקורדים. נסה שוב להוסיף אותם.");
            return;
        }

        if (loopsRaw) {
            try {
                loops = JSON.parse(loopsRaw);
            } catch (e) {
                console.log("Error parsing loops data:", e);
                loops = [];
            }
        }

        fetch("/api/add_song", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                title: title,
                artist: artist,
                key: key,
                key_type: keyType,
                difficulty: difficulty,
                time_signature: timeSignature,
                bpm: parseInt(bpm),
                video_url: finalVideoUrl,
                chords: chords,
                loops: loops
            })
        })
        .then(response => response.json())
        .then(data => {
            const messageEl = document.getElementById("response-message");
            if (data.message) {
                messageEl.textContent = "✅ " + data.message;
                messageEl.style.color = "green";

                // Clear all localStorage data after successful creation
                localStorage.removeItem("chords");
                localStorage.removeItem("loops");
                localStorage.removeItem("songData");
                localStorage.removeItem("justReturnedFromChords");
                localStorage.removeItem("addingNewSong");

                document.getElementById("chords-success").style.display = "none";

                // Reset chords button
                const chordsBtn = document.getElementById("chords-btn");
                chordsBtn.textContent = "הוסף אקורדים";
                chordsBtn.onclick = goToChordsPage;

                // Reset form
                document.getElementById("add-song-form").reset();
                document.getElementById("bpm").value = "100";
            } else {
                messageEl.textContent = "❌ שגיאה בהוספת השיר, נסה שוב";
                messageEl.style.color = "red";
            }
        })
        .catch(error => {
            document.getElementById("response-message").textContent = "❌ שגיאה בהוספת השיר!";
            document.getElementById("response-message").style.color = "red";
            console.error("Error:", error);
        });
    });
</script>

<style>
    .styled-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
        margin: auto;
    }

    .styled-form label {
        font-weight: bold;
        text-align: right;
    }

    .styled-form input,
    .styled-form select {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .btn {
        background-color: #28a745;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .btn:hover {
        background-color: #218838;
    }

    .message {
        text-align: center;
        font-weight: bold;
        margin-top: 10px;
    }
</style>
{% endblock %}
