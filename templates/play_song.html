{% extends "base.html" %}

{% block title %}נגן שיר - {{ song.title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/play_song.css') }}">
{% endblock %}

{% block content %}
<div class="play-song-container">
    <header class="song-header">
        <h1>🎵 {{ song.title }}</h1>
        <div class="song-info">
            <span class="original-bpm-display">
                <span class="bpm-icon">🎼</span>
                <span class="label">BPM מקורי:</span>
                <span class="original-bpm">{{ song.bpm }}</span>
            </span>
            <span class="current-bpm-display">
                <span class="bpm-icon">⚡</span>
                <span class="label">BPM נוכחי:</span>
                <span id="current-bpm">{{ song.bpm }}</span>
            </span>
        </div>
    </header>

    <div class="main-layout">
        <div class="controls-panel">
            <div class="control-group">
                <label class="control-label">
                    <span class="control-icon">🎛️</span>
                    הקצב הנוכחי
                </label>
                <div class="bpm-controls">
                    <input type="range" id="bpm-slider" min="40" max="200" value="{{ song.bpm }}" class="bpm-slider">
                    <input type="number" id="bpm-input" min="40" max="200" value="{{ song.bpm }}" class="bpm-input">
                    <button onclick="resetBpm()" class="reset-btn" title="אפס לקצב המקורי">
                        <span class="reset-icon">🔄</span>
                    </button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">
                    <span class="control-icon">🔊</span>
                    ווליום המטרונום
                </label>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1" class="volume-slider">
            </div>

            <!-- תיבה ריקה לתחילת השיר -->
            <div class="control-group">
                <label class="control-label">
                    <span class="control-icon">⏳</span>
                    הכנה לתחילת השיר
                </label>
                <div class="preparation-controls">
                    <label class="preparation-checkbox">
                        <input type="checkbox" id="add-preparation" checked>
                        <span class="preparation-slider"></span>
                    </label>
                    <span class="preparation-label">הוסף תיבה ריקה לתחילה</span>
                </div>
            </div>

            <div class="playback-controls">
                <button onclick="startPlayback()" class="control-btn play-btn">
                    <span class="btn-icon">▶️</span>
                    <span class="btn-text">החל לנגן</span>
                </button>
                <button onclick="restartPlayback()" class="control-btn restart-btn">
                    <span class="btn-icon">⏮️</span>
                    <span class="btn-text">התחל מחדש</span>
                </button>
                <button onclick="stopPlayback()" class="control-btn stop-btn">
                    <span class="btn-icon">⏹️</span>
                    <span class="btn-text">עצור</span>
                </button>
            </div>

            <!-- בקרת חלקי השיר -->
            <div class="control-group">
                <label class="control-label">
                    <span class="control-icon">🎼</span>
                    חלקי השיר
                </label>
                <div id="song-parts-controls" class="song-parts-controls">
                    <!-- יוכנס דינמית -->
                </div>
            </div>

            <div class="navigation-panel">
                <a href="{{ url_for('songs.chords', song_id=song.id) }}" class="nav-btn primary">
                    <span class="btn-icon">🎼</span>
                    <span class="btn-text">חזרה לעמוד השיר</span>
                </a>
                <a href="{{ url_for('songs.songs') }}" class="nav-btn secondary">
                    <span class="btn-icon">📚</span>
                    <span class="btn-text">רשימת השירים</span>
                </a>
            </div>
        </div>

        <div class="chord-section">
            <h2 class="section-title">
                <span class="title-icon">🎸</span>
                אקורדים
            </h2>

            <div class="selected-measure-info" id="selected-measure-info" style="display: none;">
                <div class="info-content">
                    <span class="info-icon">📍</span>
                    <span class="info-text">לחץ על תיבה כדי להתחיל לנגן ממנה</span>
                </div>
            </div>

            <div id="chords-wrapper" class="chords-wrapper"></div>
        </div>
    </div>
</div>

<audio id="metronome-sound" src="{{ url_for('static', filename='sounds/metronome.mp3') }}"></audio>

<script>
    // Pass data from Flask to JavaScript
    window.songData = {
        chords: {{ song.chords | tojson }},
        loops: {{ song.loops | tojson }},
        originalBpm: {{ song.bpm }}
    };
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/play_song.js') }}"></script>
{% endblock %}
