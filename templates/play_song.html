{% extends "base.html" %}

{% block title %}{{ song.title }} - {{ song.artist }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/play_song.css') }}">
{% endblock %}

{% block content %}
<div class="play-song-container">
    <header class="song-header">
        <!-- ×©×•×¨×” 1: ×©× ×”×©×™×¨ ×•×”×××Ÿ -->
        <div class="header-row-1">
            <h1>ğŸµ {{ song.title }}</h1>
            <h2 class="artist-name">{{ song.artist }}
                {% if song.song_version == 'cover' and song.original_artist %}
                    <span style="font-size: 0.7em; color: #888; font-weight: normal;">(×§××‘×¨ ×©×œ {{ song.original_artist }})</span>
                {% endif %}
            </h2>
        </div>

        <!-- ×©×•×¨×” 2: ×¤×¨×˜×™ ×”×©×™×¨, ×™×•×˜×™×•×‘ ×•×›×¤×ª×•×¨×™× -->
        <div class="header-row-2">
            <div class="song-details">
                <div class="song-info-row">
                    <span class="detail-item">
                        <span class="detail-icon">ğŸ¼</span>
                        <span class="detail-label">×¡×•×œ×:</span>
                        <span class="detail-value">{{ song.key }} ({{ song.key_type }})</span>
                    </span>
                    <span class="detail-item">
                        <span class="detail-icon">ğŸ­</span>
                        <span class="detail-label">×–'×× ×¨×™×:</span>
                        <span class="detail-value genres-display">
                            {% if song.genres and song.genres|length > 0 %}
                                {% for genre in song.genres %}
                                    <span class="genre-badge">{{ genre }}</span>{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% elif song.genre %}
                                <span class="genre-badge">{{ song.genre }}</span>
                            {% else %}
                                <span class="genre-badge">×œ× ×¦×•×™×Ÿ</span>
                            {% endif %}
                        </span>
                    </span>
                    <span class="detail-item">
                        <span class="detail-icon">â±ï¸</span>
                        <span class="detail-label">××§×¦×‘:</span>
                        <span class="detail-value">{{ song.time_signature }}</span>
                    </span>
                    {% if song.difficulty %}
                    <span class="detail-item">
                        <span class="detail-icon">â­</span>
                        <span class="detail-label">×¨××ª ×§×•×©×™:</span>
                        <span class="detail-value">{{ song.difficulty }}
                            {% if not song.difficulty_approved %}
                                <span class="pending-approval">*</span>
                            {% endif %}
                        </span>
                    </span>
                    {% endif %}
                </div>
            </div>

            <!-- × ×’×Ÿ ×™×•×˜×™×•×‘ -->
            <div class="youtube-player-section">
                <button onclick="toggleYouTubePlayer()" class="youtube-toggle-btn">
                    <span class="youtube-icon">ğŸ“º</span>
                    <span>×”×©××¢/×”×¡×ª×¨ ×•×™×“××•</span>
                </button>
                <div id="youtube-player-container" class="youtube-player-container" style="display: none;">
                    <button onclick="toggleYouTubePlayer()" class="close-youtube-btn">Ã—</button>
                    <iframe id="youtube-iframe" src="{{ song.video_url }}" frameborder="0" allowfullscreen></iframe>
                </div>
                {% if song.tutorial_video_url %}
                <button onclick="toggleTutorialPlayer()" class="youtube-toggle-btn" style="margin-top: 10px;">
                    <span class="youtube-icon">ğŸ“š</span>
                    <span>×¤×ª×—/×¡×’×•×¨ ×¡×¨×˜×•×Ÿ ×”×“×¨×›×”</span>
                </button>
                <div id="tutorial-player-container" class="youtube-player-container" style="display: none;">
                    <button onclick="toggleTutorialPlayer()" class="close-youtube-btn">Ã—</button>
                    <iframe id="tutorial-iframe" src="{{ song.tutorial_video_url }}" frameborder="0" allowfullscreen></iframe>
                </div>
                {% endif %}
            </div>

            <!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” -->
            <div class="action-buttons">
                {% if session.get('user_id') == song.created_by %}
                <a href="{{ url_for('songs.edit_song', song_id=song.id) }}" class="action-btn edit-btn">
                    <span>âœï¸</span>
                    <span>×¢×¨×•×š ×©×™×¨</span>
                </a>
                {% endif %}
                <a href="{{ url_for('songs.songs') }}" class="action-btn list-btn">
                    <span>ğŸ“š</span>
                    <span>×—×–×¨×” ×œ×¨×©×™××”</span>
                </a>
                {% if session.get('user_id') %}
                <button id="my-songs-btn" onclick="toggleMySong()" class="action-btn my-songs-btn">
                    <span id="my-songs-icon">â¤ï¸</span>
                    <span id="my-songs-text">×”×•×¡×£ ×œ×©×™×¨×™× ×©×œ×™</span>
                </button>
                {% endif %}
            </div>
        </div>

        <!-- ×©×•×¨×” 3: ××™×“×¢ BPM -->
        <div class="header-row-3">
            <div class="bpm-info">
                <span class="original-bpm-display">
                    <span class="label">BPM ××§×•×¨×™:</span>
                    <span>{{ song.bpm }}</span>
                </span>
                <span class="current-bpm-display">
                    <span class="label">BPM × ×•×›×—×™:</span>
                    <span id="current-bpm">{{ song.bpm }}</span>
                </span>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <div class="controls-panel">
            <!-- ×‘×§×¨×ª BPM -->
            <div class="control-group">
                <label for="bpm-slider" class="control-label">
                    <span class="control-icon">ğŸ¥</span>
                    ××”×™×¨×•×ª (BPM)
                </label>
                <div class="bpm-controls">
                    <input type="range" id="bpm-slider" min="40" max="200" value="{{ song.bpm }}" class="bpm-slider">
                    <input type="number" id="bpm-input" min="40" max="200" value="{{ song.bpm }}" class="bpm-input">
                    <button onclick="resetBpm()" class="reset-btn" title="××¤×¡ BPM ×œ××§×•×¨×™">ğŸ”„</button>
                </div>
            </div>

            <!-- ×‘×§×¨×ª ×¢×•×¦××” -->
            <div class="control-group">
                <label for="volume-slider" class="control-label">
                    <span class="control-icon">ğŸ”Š</span>
                    ×¢×•×¦××ª ××˜×¨×•× ×•×
                </label>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1" class="volume-slider">
            </div>

            <!-- ×‘×§×¨×ª ×˜×¨× ×¡×¤×•×–×™×¦×™×” -->
            <div class="control-group">
                <label for="transpose-slider" class="control-label">
                    <span class="control-icon">ğŸ¹</span>
                    ×˜×¨× ×¡×¤×•×–×™×¦×™×”
                </label>
                <div class="transpose-controls">
                    <div class="transpose-buttons">
                        <button onclick="transposeDown()" class="transpose-btn decrease" title="×”×•×¨×“ ×‘×˜×•×Ÿ">â¬‡ï¸</button>
                        <input type="number" id="transpose-input" min="-6" max="6" step="0.5" value="0" class="transpose-input">
                        <button onclick="transposeUp()" class="transpose-btn" title="×”×¢×œ×” ×‘×˜×•×Ÿ">â¬†ï¸</button>
                    </div>
                    <input type="range" id="transpose-slider" min="-6" max="6" step="0.5" value="0" class="transpose-slider">
                    <button onclick="resetTranspose()" class="reset-btn" title="××¤×¡ ×˜×¨× ×¡×¤×•×–×™×¦×™×”">ğŸ”„</button>
                </div>
                <div class="transpose-info" id="transpose-info">
                    <span>×©×™× ×•×™: 0 ×˜×•× ×™× (0 ×¡××™×˜×•× ×™×)</span>
                </div>
            </div>

            <!-- Size Controls Section -->
            <div class="control-group">
                <div class="size-controls">
                    <div class="size-controls-title">
                        <span class="control-icon">ğŸ“</span>
                        ×‘×§×¨×ª ×’×•×“×œ ×”×ª×™×‘×•×ª ×•×”×¤×•× ×˜
                    </div>

                    <div class="size-control-row">
                        <span class="size-control-label">×’×•×“×œ ×”×ª×™×‘×•×ª:</span>
                        <div class="size-control-buttons">
                            <button onclick="decreaseMeasureSize()" class="size-btn decrease" title="×”×§×˜×Ÿ ×ª×™×‘×•×ª (Ctrl + -)">âˆ’</button>
                            <button onclick="increaseMeasureSize()" class="size-btn" title="×”×’×“×œ ×ª×™×‘×•×ª (Ctrl + +)">+</button>
                        </div>
                    </div>

                    <div class="size-control-row">
                        <span class="size-control-label">×’×•×“×œ ×”×¤×•× ×˜:</span>
                        <div class="size-control-buttons">
                            <button onclick="decreaseFontSize()" class="size-btn decrease" title="×”×§×˜×Ÿ ×¤×•× ×˜ (Shift + -)">âˆ’</button>
                            <button onclick="increaseFontSize()" class="size-btn" title="×”×’×“×œ ×¤×•× ×˜ (Shift + +)">+</button>
                        </div>
                    </div>

                    <button onclick="resetSizes()" class="reset-all-btn" title="××¤×¡ ×’×“×œ×™× (Ctrl + 0)">
                        <span>ğŸ”„</span>
                        <span>××¤×¡ ×’×“×œ×™×</span>
                    </button>

                    <div class="help-text">
                        ğŸ’¡ × ×™×ª×Ÿ ×œ×”×©×ª××© ×‘×§×™×¦×•×¨×™ ×“×¨×š: CtrlÂ±/ShiftÂ± ×œ×”×’×“×œ×”/×”×§×˜× ×”, Ctrl+0 ×œ××™×¤×•×¡
                    </div>
                </div>
            </div>

            <!-- User Instructions -->
            <div class="control-group">
                <div class="user-instructions">
                    <div class="instructions-title">
                        <span class="control-icon">ğŸ¯</span>
                        ××™×š ×œ×”×©×ª××© ×‘× ×’×Ÿ
                    </div>

                    <div class="instruction-item">
                        <span class="instruction-icon">ğŸ‘†</span>
                        <span>×œ×—×¥ ×¢×œ ×ª×™×‘×” ×›×“×™ ×œ×”×ª×—×™×œ ×œ× ×’×Ÿ ××× ×”</span>
                    </div>

                    <div class="instruction-item">
                        <span class="instruction-icon">ğŸµ</span>
                        <span>×œ×—×¥ ×¢×œ ××§×•×¨×“ ×¡×¤×¦×™×¤×™ ×‘×ª×•×š ×ª×™×‘×”</span>
                    </div>

                    <div class="instruction-item">
                        <span class="instruction-icon">â¯ï¸</span>
                        <span>×¨×•×•×— = × ×’×Ÿ/×¢×¦×•×¨, Ctrl+R = ×”×ª×—×œ ××—×“×©</span>
                    </div>

                    <div class="instruction-item">
                        <span class="instruction-icon">ğŸ”¢</span>
                        <span>×ª××™×“ 4 ×ª×™×‘×•×ª ×‘×©×•×¨×” ×œ×ª×¦×•×’×” × ×•×—×”</span>
                    </div>

                    <div class="instruction-item">
                        <span class="instruction-icon">âœ…</span>
                        <span>×›×‘×”/×”×“×œ×§ ×—×œ×§×™ ×©×™×¨ ×‘×¢××•×“×” ×–×•</span>
                    </div>
                </div>
            </div>

            <!-- ×ª×™×‘×” ×¨×™×§×” ×œ×ª×—×™×œ×ª ×”×©×™×¨ -->
            <div class="control-group">
                <label class="control-label">
                    <span class="control-icon">â³</span>
                    ×”×›× ×” ×œ×ª×—×™×œ×ª ×”×©×™×¨
                </label>
                <div class="preparation-controls">
                    <label class="preparation-checkbox">
                        <input type="checkbox" id="add-preparation" checked>
                        <span class="preparation-slider"></span>
                    </label>
                    <span class="preparation-label">×”×•×¡×£ ×ª×™×‘×” ×¨×™×§×” ×œ×ª×—×™×œ×”</span>
                </div>
            </div>

            <div class="playback-controls">
                <button onclick="startPlayback()" class="control-btn play-btn">
                    <span class="btn-icon">â–¶ï¸</span>
                    <span class="btn-text">×”×—×œ ×œ× ×’×Ÿ</span>
                </button>
                <button onclick="restartPlayback()" class="control-btn restart-btn">
                    <span class="btn-icon">â®ï¸</span>
                    <span class="btn-text">×”×ª×—×œ ××—×“×©</span>
                </button>
                <button onclick="stopPlayback()" class="control-btn stop-btn">
                    <span class="btn-icon">â¹ï¸</span>
                    <span class="btn-text">×¢×¦×•×¨</span>
                </button>
            </div>

            <!-- ×‘×§×¨×ª ×—×œ×§×™ ×”×©×™×¨ -->
            <div class="control-group">
                <label class="control-label">
                    <span class="control-icon">ğŸ¼</span>
                    ×—×œ×§×™ ×”×©×™×¨
                </label>
                <div id="song-parts-controls" class="song-parts-controls">
                    <!-- ×™×•×›× ×¡ ×“×™× ××™×ª -->
                </div>
            </div>
        </div>

        <div class="chord-section">
            <h2 class="section-title">
                <span class="title-icon">ğŸ¸</span>
                ××§×•×¨×“×™×
            </h2>

            <div class="selected-measure-info" id="selected-measure-info" style="display: none;">
                <div class="info-content">
                    <span class="info-icon">ğŸ“</span>
                    <span class="info-text">×œ×—×¥ ×¢×œ ×ª×™×‘×” ×›×“×™ ×œ×”×ª×—×™×œ ×œ× ×’×Ÿ ××× ×”</span>
                </div>
            </div>

            <div id="chords-wrapper" class="chords-wrapper"></div>
        </div>
    </div>
</div>

<!-- Size Indicator -->
<div id="size-indicator" class="size-indicator"></div>

<audio id="metronome-sound" src="{{ url_for('static', filename='sounds/metronome.mp3') }}"></audio>

<script>
    // Pass data from Flask to JavaScript
    window.songData = {
        songId: "{{ song.id }}",
        chords: {{ song.chords | tojson }},
        loops: {{ song.loops | tojson }},
        originalBpm: {{ song.bpm }}
    };

    // × ×’×Ÿ ×™×•×˜×™×•×‘
    function toggleYouTubePlayer() {
        const container = document.getElementById('youtube-player-container');
        const isVisible = container.style.display !== 'none';

        if (isVisible) {
            container.style.display = 'none';
            // ×¢×¦×•×¨ ×•×™×“××• ×× × ×¡×’×¨
            const iframe = document.getElementById('youtube-iframe');
            const src = iframe.src;
            iframe.src = '';
            iframe.src = src;
        } else {
            container.style.display = 'block';
        }
    }

    // × ×’×Ÿ ×¡×¨×˜×•×Ÿ ×”×“×¨×›×”
    function toggleTutorialPlayer() {
        const container = document.getElementById('tutorial-player-container');
        const isVisible = container.style.display !== 'none';

        if (isVisible) {
            container.style.display = 'none';
            // ×¢×¦×•×¨ ×•×™×“××• ×× × ×¡×’×¨
            const iframe = document.getElementById('tutorial-iframe');
            const src = iframe.src;
            iframe.src = '';
            iframe.src = src;
        } else {
            container.style.display = 'block';
        }
    }

    // × ×§×” ××–×”×™× ××”×•×¡×¤×”/×¢×¨×™×›×” ×§×•×“××™×
    localStorage.removeItem("editingSongId");
    localStorage.removeItem("editSongData");
</script>

<style>
/* Additional styles for genre display */
.genres-display {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: center;
}

.genre-badge {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-block;
    white-space: nowrap;
}

.genre-badge:only-child {
    /* If there's only one genre, make it slightly larger */
    padding: 3px 10px;
    font-size: 0.85rem;
}

@media (max-width: 768px) {
    .genres-display {
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
    }

    .genre-badge {
        font-size: 0.75rem;
        padding: 2px 6px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/play_song.js') }}"></script>
{% endblock %}
