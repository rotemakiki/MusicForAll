{% extends "base.html" %}

{% block title %} 砖专 - {{ song.title }}{% endblock %}

{% block content %}
<h2>{{ song.title }}</h2>

<div id="bpm-info">BPM: {{ song.bpm }}</div>
<div id="controls" style="margin: 20px 0;">
    <div>
        <label>拽爪 : <span id="current-bpm">{{ song.bpm }}</span> BPM</label><br>
        <input type="range" id="bpm-slider" min="40" max="200" value="{{ song.bpm }}">
        <input type="number" id="bpm-input" min="40" max="200" value="{{ song.bpm }}" style="width: 70px; margin-right: 15px;">
        <button onclick="resetBpm()"> 驻住 BPM</button>
    </div>

    <div style="margin-top: 10px;">
        <label>  专:</label>
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
    </div>

    <div style="margin-top: 10px;">
        <button onclick="startPlayback()"> </button>
        <button onclick="restartPlayback()">转 砖</button>
        <button onclick="stopPlayback()">注爪专</button>
    </div>
</div>

<div id="chord-container">
    <h3>拽专</h3>
    <div id="chords-wrapper"></div>
</div>

<audio id="metronome-sound" src="{{ url_for('static', filename='sounds/metronome.mp3') }}"></audio>

<div class="buttons" style="margin-top: 20px;">
    <a href="{{ url_for('songs.chords', song_id=song.id) }}" class="btn"> 专 注 砖专</a>
    <a href="{{ url_for('songs.songs') }}" class="btn"> 专 专砖转 砖专</a>
</div>

<style>
    .chord-row {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .chord-box {
        border: 2px solid #aaa;
        border-radius: 10px;
        width: 120px;
        height: 100px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        font-weight: bold;
        font-size: 18px;
        padding: 6px 0;
        box-sizing: border-box;
        transition: background-color 0.3s ease;
        position: relative;
        cursor: pointer;
    }

    .active {
        background-color: lightgreen;
        border-color: green;
    }

    .selected-chord-box {
        border: 2px solid blue !important;
        box-shadow: 0 0 8px blue;
    }

    .beat-indicators {
        display: flex;
        gap: 4px;
        justify-content: center;
        margin-top: 4px;
    }

    .beat-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #ccc;
    }

    .beat-dot.active-dot {
        background-color: #007bff;
    }

    #bpm-info {
        margin-bottom: 10px;
        font-weight: bold;
        font-size: 16px;
    }

    .buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .btn {
        background-color: #007bff;
        color: white;
        padding: 10px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: bold;
        transition: background 0.3s ease;
    }

    .btn:hover {
        background-color: #0056b3;
    }
</style>

<script>
    // 拽转 专砖转 拽专  砖 (拽)
    const chords = {{ song.chords | tojson }};
    let bpm = {{ song.bpm }};
    let intervalMs = 60000 / bpm;

    let currentLineIndex = 0;
    let currentChordIndexInLine = 0;
    let currentBeat = 0;
    let interval = null;

    let selectedStartLine = null;
    let selectedStartChord = null;

    const metronome = document.getElementById("metronome-sound");

    // English comment: Render the chords on the page
    function renderChords() {
        const wrapper = document.getElementById("chords-wrapper");
        wrapper.innerHTML = "";

        let chordNumber = 1; // cumulative for all chords

        chords.forEach((line, lineIdx) => {
            const rowDiv = document.createElement("div");
            rowDiv.className = "chord-row";
            rowDiv.style.direction = "ltr"; // Left to right display

            line.forEach((chordObj, chordIdx) => {
                const box = document.createElement("div");
                box.className = "chord-box";

                // Display cumulative number
                const barNumber = document.createElement("div");
                barNumber.style.fontSize = "13px";
                barNumber.style.color = "#888";
                barNumber.innerText = chordNumber;
                box.appendChild(barNumber);

                // Show chord name
                const chordName = document.createElement("div");
                chordName.style.fontSize = "20px";
                chordName.style.fontWeight = "bold";
                chordName.innerText = chordObj.chord;
                box.appendChild(chordName);

                // Show beats
                const chordBeats = document.createElement("div");
                chordBeats.style.fontSize = "16px";
                chordBeats.style.color = "#226";
                chordBeats.innerText = chordObj.beats + " 拽砖转";
                box.appendChild(chordBeats);

                // Show label if exists
                if (chordObj.label) {
                    const chordLabel = document.createElement("div");
                    chordLabel.style.fontSize = "14px";
                    chordLabel.style.color = "#444";
                    chordLabel.innerText = chordObj.label;
                    box.appendChild(chordLabel);
                }

                // Highlight if selected or playing
                const isCurrent = lineIdx === currentLineIndex && chordIdx === currentChordIndexInLine;
                const isPast = (
                    lineIdx < currentLineIndex ||
                    (lineIdx === currentLineIndex && chordIdx < currentChordIndexInLine)
                );
                const isSelected = lineIdx === selectedStartLine && chordIdx === selectedStartChord;
                if (isSelected) box.classList.add("selected-chord-box");
                if (isPast) box.classList.add("active");

                // Show beat indicators only for current chord
                if (isCurrent) {
                    const indicators = document.createElement("div");
                    indicators.className = "beat-indicators";
                    for (let j = 0; j < chordObj.beats; j++) {
                        const dot = document.createElement("div");
                        dot.className = "beat-dot";
                        if (j < currentBeat) dot.classList.add("active-dot");
                        indicators.appendChild(dot);
                    }
                    box.appendChild(indicators);
                } else {
                    // Spacer for layout
                    const spacer = document.createElement("div");
                    spacer.style.height = "16px";
                    box.appendChild(spacer);
                }

                // Click to select chord as starting point
                box.addEventListener("click", () => {
                    selectedStartLine = lineIdx;
                    selectedStartChord = chordIdx;
                    renderChords();
                });

                rowDiv.appendChild(box);
                chordNumber++; // For cumulative numbering
            });

            wrapper.appendChild(rowDiv);
        });
    }

    // English comment: Play metronome sound
    function playMetronome() {
        metronome.currentTime = 0;
        metronome.play().catch(() => {});
    }

    // English comment: Start the playback of the song by chords and beats
    function startPlayback() {
        stopPlayback();
        bpm = parseInt(document.getElementById("bpm-slider").value);
        intervalMs = 60000 / bpm;
        document.getElementById("current-bpm").innerText = bpm;

        // Start from selected, or from beginning
        currentLineIndex = selectedStartLine !== null ? selectedStartLine : 0;
        currentChordIndexInLine = selectedStartChord !== null ? selectedStartChord : 0;
        currentBeat = 0;

        renderChords();
        playMetronome();

        interval = setInterval(() => {
            const line = chords[currentLineIndex];
            const chordObj = line[currentChordIndexInLine];
            const beatsThisChord = chordObj.beats || 4;

            playMetronome();
            currentBeat++;

            if (currentBeat > beatsThisChord) {
                currentBeat = 1;
                currentChordIndexInLine++;
                if (currentChordIndexInLine >= chords[currentLineIndex].length) {
                    currentChordIndexInLine = 0;
                    currentLineIndex++;
                    if (currentLineIndex >= chords.length) {
                        stopPlayback();
                        return;
                    }
                }
            }

            renderChords();
        }, intervalMs);
    }

    function stopPlayback() {
        clearInterval(interval);
        interval = null;
    }

    function restartPlayback() {
        stopPlayback();
        currentLineIndex = 0;
        currentChordIndexInLine = 0;
        currentBeat = 0;
        selectedStartLine = null;
        selectedStartChord = null;
        renderChords();
    }

    document.addEventListener("DOMContentLoaded", () => {
        const bpmSlider = document.getElementById("bpm-slider");
        const bpmInput = document.getElementById("bpm-input");

        bpmSlider.addEventListener("input", (e) => {
            bpm = parseInt(e.target.value);
            bpmInput.value = bpm;
            document.getElementById("current-bpm").innerText = bpm;
            intervalMs = 60000 / bpm;
        });

        bpmInput.addEventListener("change", (e) => {
            let val = parseInt(e.target.value);
            if (isNaN(val) || val < 40) val = 40;
            if (val > 200) val = 200;

            bpmInput.value = val;
            bpmSlider.value = val;
            bpm = val;
            document.getElementById("current-bpm").innerText = bpm;
            intervalMs = 60000 / bpm;
        });

        renderChords();
    });

    document.getElementById("volume-slider").addEventListener("input", (e) => {
        metronome.volume = parseFloat(e.target.value);
    });

    function resetBpm() {
        const defaultBpm = {{ song.bpm }};
        bpm = defaultBpm;
        intervalMs = 60000 / bpm;
        document.getElementById("bpm-slider").value = bpm;
        document.getElementById("bpm-input").value = bpm;
        document.getElementById("current-bpm").innerText = bpm;
    }

</script>
{% endblock %}
